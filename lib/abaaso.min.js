/*
 2013 Jason Mulligan
 @license BSD-3 <https://raw.github.com/avoidwork/abaaso/master/LICENSE>
 @link http://abaaso.com
 @module abaaso
 @version 4.0.0
*/
(function(global){var document=global.document,location=global.location,navigator=global.navigator,server=typeof exports!=="undefined",framework,http,https,url,WORKER;if(global.abaaso!==undefined)return;if(server){url=require("url");http=require("http");https=require("https");mongodb=require("mongodb").MongoClient;format=require("util").format;if(typeof Storage==="undefined")localStorage=require("localStorage");if(typeof XMLHttpRequest==="undefined")XMLHttpRequest=null}framework=function(){var bootstrap,
external,has,slice;var regex={after_space:/\s+.*/,android:/android/i,allow:/^allow$/i,allow_cors:/^access-control-allow-methods$/i,alphanum:/^[a-zA-Z0-9]+$/,and:/^&/,args:/\((.*)\)/,asc:/\s+asc$/ig,auth:/\/\/(.*)\@/,blackberry:/blackberry/i,body:/\{(.*)\}/,"boolean":/^(true|false)?$/,boolean_number_string:/boolean|number|string/,cdata:/\&|<|>|\"|\'|\t|\r|\n|\@|\$/,checked_disabled:/checked|disabled/i,chrome:/chrome/i,complete_loaded:/^(complete|loaded)$/i,csv_quote:/^\s|\"|\n|,|\s$/,del:/^del/,decimal:/^\d+.(\d+)/,
desc:/\s+desc$/i,domain:/^[\w.-_]+\.[A-Za-z]{2,}$/,double_slash:/\/\//,down:/down/,down_up:/down|up/,email:/^[a-zA-Z0-9.!#$%&'*+\/=?\^_`{|}~\-]+@[a-zA-Z0-9](?:[a-zA-Z0-9\-]{0,253}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9\-]{0,253}[a-zA-Z0-9])?)*$/,endslash:/\/$/,element_update:/innerHTML|innerText|textContent|type|src/,firefox:/firefox/i,get_headers:/^(head|get|options)$/,get_remove_set:/get|remove|set/,hash:/^\#/,hash_bang:/^\#\!?/,header_replace:/:.*/,header_value_replace:/.*:\s+/,html:/^<.*>$/,
http_body:/200|202|203|206/,http_ports:/80|443/,ie:/msie|ie/i,input_button:/button|submit|reset/,integer:/(^-?\d\d*$)/,ip:/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,is_xml:/^<\?xml.*\?>/,ios:/ipad|iphone/i,json_maybe:/json|plain|javascript/,json_wrap:/^[\[\{]/,jsonp_wrap:/([a-zA-Z0-9\.]+\()(.*)(\))$/,klass:/^\./,linux:/linux|bsd|unix/i,no:/no/i,not_endpoint:/.*\//,notEmpty:/\w{1,}/,number:/(^-?\d\d*\.\d*$)|(^-?\d\d*$)|(^-?\.\d\d*$)|number/,number_format_1:/.*\./,
number_format_2:/\..*/,number_present:/\d{1,}/,number_string:/number|string/i,number_string_object:/number|object|string/i,null_undefined:/null|undefined/,observer_globals:/body|document|window/i,object_type:/\[object Object\]/,object_undefined:/object|undefined/,opera:/opera/i,osx:/macintosh/i,patch:/^patch$/,phone:/^([0-9\(\)\/\+ \-\.]+)$/,playbook:/playbook/i,plural:/s$/,primitive:/^(boolean|function|number|string)$/,priv:/private/,put_post:/^(post|put)$/i,radio_checkbox:/^(radio|checkbox)$/i,
reflect:/function\s+\w*\s*\((.*?)\)/,root:/^\/[^\/]/,route_nget:/^(head|options)$/i,route_methods:/^(all|delete|get|put|post|head|options)$/i,safari:/safari/i,scheme:/.*\/\//,select:/select/i,selector_is:/^:/,selector_many:/\:|\.|\+|\~|\[/,selector_complex:/\s+|\>|\+|\~|\:|\[/,selector_split:/\s+|\>|\+|\~/,set_del:/^(set|del|delete)$/,sort_needle:/^.*:::/,sort_value:/:::.*$/,space_hyphen:/\s|-/,string_boolean:/^(true|false)$/i,string_object:/string|object/i,string_true:/^true$/i,svg:/svg/,top_bottom:/top|bottom/i,
true_undefined:/true|undefined/i,url:/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/i,
webos:/webos/i,windows:/windows/i,word:/^\w+$/,xml:/xml/i};var array={add:function(obj,arg){if(!array.contains(obj,arg))obj.push(arg);return obj},binIndex:function(obj,arg){var min=0,max=obj.length-1,idx,val;while(min<=max){idx=Math.floor((min+max)/2);val=obj[idx];if(val<arg)min=idx+1;else if(val>arg)max=idx-1;else return idx}return-1},cast:function(obj,key){key=key===true;var o=[];if(!isNaN(obj.length))o=slice.call(obj);else if(key)o=array.keys(obj);else utility.iterate(obj,function(i){o.push(i)});
return o},chunk:function(obj,size){var result=[],nth=number.round(obj.length/size,"up"),start=0,i=-1;while(++i<nth){start=i*size;result.push(array.limit(obj,start,size))}return result},clear:function(obj){return obj.length>0?array.remove(obj,0,obj.length):obj},clone:function(obj){return obj.slice()},contains:function(obj,arg){return array.index(obj,arg)>-1},collect:function(obj,fn){var result=[];array.each(obj,function(i){result.push(fn(i))});return result},compact:function(obj,diff){var result=[];
result=obj.filter(function(i){return!regex.null_undefined.test(i)});return!diff?result:result.length<obj.length?result:null},count:function(obj,value){return obj.filter(function(i){return i===value}).length},diff:function(array1,array2){var result=[];array.each(array1,function(i){if(!array.contains(array2,i))array.add(result,i)});array.each(array2,function(i){if(!array.contains(array1,i))array.add(result,i)});return result},each:function(obj,fn,async,size){var nth=obj.length,i,offset;if(async!==true)for(i=
0;i<nth;i++){if(fn.call(obj,obj[i],i)===false)break}else{size=size||10;offset=0;if(size>nth)size=nth;utility.repeat(function(){var i=0,idx;for(i=0;i<size;i++){idx=i+offset;if(idx===nth||fn.call(obj,obj[idx],idx)===false)return false}offset+=size;if(offset>=nth)return false},undefined,undefined,false)}return obj},empty:function(obj){return obj.length===0},equal:function(a,b){return json.encode(a)===json.encode(b)},fib:function(arg){var result=[1,1],first=result[0],second=result[1],sum;arg=(arg||100)-
1;if(isNaN(arg)||arg<2)throw new Error(label.error.invalidArguments);while(--arg){sum=first+second;first=second;second=sum;result.push(sum)}return result},fill:function(obj,arg,start,offset){var fn=typeof arg==="function",l=obj.length,i=!isNaN(start)?start:0,nth=!isNaN(offset)?i+offset:l-1;if(nth>l-1)nth=l-1;while(i<=nth){obj[i]=fn?arg(obj[i]):arg;i++}return obj},first:function(obj){return obj[0]},forEach:function(obj,fn,async,size){return array.each(obj,fn,async,size)},flat:function(obj){var result=
[];result=obj.reduce(function(a,b){return a.concat(b)},result);return result},fromObject:function(obj){return array.mingle(array.keys(obj),array.cast(obj))},index:function(obj,arg){return obj.indexOf(arg)},indexed:function(obj){var indexed=[];utility.iterate(obj,function(v){indexed.push(v)});return indexed},intersect:function(array1,array2){var a=array1.length>array2.length?array1:array2,b=a===array1?array2:array1;return a.filter(function(key){return array.contains(b,key)})},keepIf:function(obj,fn){if(typeof fn!==
"function")throw new Error(label.error.invalidArguments);var result=[],remove=[];result=obj.filter(fn);remove=array.diff(obj,result);array.each(remove,function(i){array.remove(obj,array.index(obj,i))});return obj},keySort:function(obj,query,sub){query=query.replace(/\s*asc/ig,"").replace(/\s*desc/ig," desc");var queries=string.explode(query).map(function(i){return i.split(" ")}),sorts=[];if(sub&&sub!=="")sub="."+sub;else sub="";array.each(queries,function(i){var desc=i[1]==="desc";if(!desc){sorts.push("if ( a"+
sub+'["'+i[0]+'"] < b'+sub+'["'+i[0]+'"] ) return -1;');sorts.push("if ( a"+sub+'["'+i[0]+'"] > b'+sub+'["'+i[0]+'"] ) return 1;')}else{sorts.push("if ( a"+sub+'["'+i[0]+'"] < b'+sub+'["'+i[0]+'"] ) return 1;');sorts.push("if ( a"+sub+'["'+i[0]+'"] > b'+sub+'["'+i[0]+'"] ) return -1;')}});sorts.push("else return 0;");return obj.sort(new Function("a","b",sorts.join("\n")))},keys:function(obj){return Object.keys(obj)},last:function(obj,arg){var n=obj.length-1;if(arg>=n+1)return obj;else if(isNaN(arg)||
arg===1)return obj[n];else return array.limit(obj,n- --arg,n)},limit:function(obj,start,offset){var result=[],i=start-1,nth=start+offset,max=obj.length;if(max>0)while(++i<nth&&i<max)result.push(obj[i]);return result},max:function(obj){return array.last(obj.sort(array.sort))},mean:function(obj){return obj.length>0?array.sum(obj)/obj.length:undefined},median:function(obj){var nth=obj.length,mid=number.round(nth/2,"down"),sorted=obj.sort(array.sort);return number.odd(nth)?sorted[mid]:(sorted[mid-1]+
sorted[mid])/2},merge:function(obj,arg){array.each(arg,function(i){array.add(obj,i)});return obj},min:function(obj){return obj.sort(array.sort)[0]},mingle:function(obj1,obj2){var result;result=obj1.map(function(i,idx){return[i,obj2[idx]]});return result},mode:function(obj){var values={},count=0,nth=0,mode=[],result;array.each(obj,function(i){if(!isNaN(values[i]))values[i]++;else values[i]=1});count=array.max(array.cast(values));utility.iterate(values,function(v,k){if(v===count)mode.push(number.parse(k))});
nth=mode.length;if(nth>0)result=nth===1?mode[0]:mode;return result},percents:function(obj,precision,total){var result=[],custom=false,last,padding,sum;precision=precision||0;if(total===undefined)total=array.sum(obj);else custom=true;array.each(obj,function(i){result.push(number.parse((i/total*100).toFixed(precision)))});if(!custom){sum=array.sum(result);if(sum<100){padding=number.parse(number.diff(sum,100).toFixed(precision));last=array.last(result)+padding;result[result.length-1]=last}else if(sum>
100){padding=number.parse(number.diff(sum,100).toFixed(precision));last=number.parse((array.last(result)-padding).toFixed(precision));result[result.length-1]=last}}return result},range:function(obj){return array.max(obj)-array.min(obj)},rassoc:function(obj,arg){var result;array.each(obj,function(i,idx){if(i[1]===arg){result=obj[idx];return false}});return result},reject:function(obj,fn){return array.diff(obj,obj.filter(fn))},replace:function(obj,arg){array.remove(obj,0,obj.length);array.each(arg,
function(i){obj.push(i)});return obj},remove:function(obj,start,end){if(isNaN(start)){start=array.index(obj,start);if(start===-1)return obj}else start=start||0;var length=obj.length,remaining=obj.slice((end||start)+1||length);obj.length=start<0?length+start:start;obj.push.apply(obj,remaining);return obj},removeIf:function(obj,fn){var remove;if(typeof fn!=="function")throw new Error(label.error.invalidArguments);remove=obj.filter(fn);array.each(remove,function(i){array.remove(obj,array.index(obj,i))});
return obj},removeWhile:function(obj,fn){if(typeof fn!=="function")throw new Error(label.error.invalidArguments);var remove=[];array.each(obj,function(i){if(fn(i)!==false)remove.push(i);else return false});array.each(remove,function(i){array.remove(obj,array.index(obj,i))});return obj},rest:function(obj,arg){arg=arg||1;if(arg<1)arg=1;return array.limit(obj,arg,obj.length)},rindex:function(obj,arg){var result=-1;array.each(obj,function(i,idx){if(i===arg)result=idx});return result},rotate:function(obj,
arg){var nth=obj.length,result;if(arg===0)result=obj;else{if(arg<0)arg+=nth;else arg--;result=array.limit(obj,arg,nth);result=result.concat(array.limit(obj,0,arg))}return result},series:function(start,end,offset){start=start||0;end=end||start;offset=offset||1;var result=[],n=-1,nth=Math.max(0,Math.ceil((end-start)/offset));while(++n<nth){result[n]=start;start+=offset}return result},split:function(obj,divisor){var result=[],total=obj.length,nth=Math.ceil(total/divisor),low=Math.floor(total/divisor),
lower=Math.ceil(total/nth),lowered=false,start=0,i=-1;if(number.diff(total,divisor*nth)>nth)lower=total-low*divisor+low-1;while(++i<divisor){if(!lowered&&(lower<divisor&&i===lower)){--nth;lowered=true}if(i>0)start=start+nth;result.push(array.limit(obj,start,nth))}return result},sort:function(a,b){var types={a:typeof a,b:typeof b},c,d,result;if(types.a==="number"&&types.b==="number")result=a-b;else{c=a.toString();d=b.toString();if(c<d)result=-1;else if(c>d)result=1;else if(types.a===types.b)result=
0;else if(types.a==="boolean")result=-1;else result=1}return result},sorted:function(obj){return obj.sort(array.sort)},sum:function(obj){var result=0;if(obj.length>0)result=obj.reduce(function(prev,cur){return prev+cur});return result},take:function(obj,arg){return array.limit(obj,0,arg)},total:function(obj){return array.indexed(obj).length},toObject:function(ar){var obj={},i=ar.length;while(i--)obj[i.toString()]=ar[i];return obj},unique:function(obj){var result=[];array.each(obj,function(i){array.add(result,
i)});return result},zip:function(obj,args){var result=[];if(!(args instanceof Array))args=typeof args==="object"?array.cast(args):[args];array.each(args,function(i,idx){if(!(i instanceof Array))this[idx]=[i]});array.each(obj,function(i,idx){result[idx]=[i];array.each(args,function(x){result[idx].push(x[idx]||null)})});return result}};var cache={items:{},clean:function(){return utility.iterate(cache.items,function(v,k){if(cache.expired(k))cache.expire(k,true)})},expire:function(uri,silent){silent=
silent===true;if(cache.items[uri]!==undefined){delete cache.items[uri];if(!silent)observer.fire(uri,"beforeExpire, expire, afterExpire");return true}else return false},expired:function(uri){var item=cache.items[uri];return item!==undefined&&(item.expires!==undefined&&item.expires<new Date)},get:function(uri,expire){uri=utility.parse(uri).href;expire=expire!==false;if(cache.items[uri]===undefined)return false;if(expire&&cache.expired(uri)){cache.expire(uri);return false}return utility.clone(cache.items[uri],
true)},set:function(uri,property,value){uri=utility.parse(uri).href;if(cache.items[uri]===undefined){cache.items[uri]={};cache.items[uri].permission=0}if(property==="permission")cache.items[uri].permission|=value;else if(property==="!permission")cache.items[uri].permission&=~value;else cache.items[uri][property]=value;return cache.items[uri]}};var channel=function(){return new Channel};function Channel(){this.queue=[]}Channel.prototype.constructor=Channel;Channel.prototype.put=function(arg){var defer=
deferred();if(this.queue.length===0){this.queue.push(arg);defer.resolve(["continue",null])}else defer.resolve(["pause",null]);return defer};Channel.prototype.take=function(){var defer=deferred();if(this.queue.length===0)defer.resolve(["pause",null]);else defer.resolve(["continue",this.queue.pop()]);return defer};var client={activex:function(){var result=false,obj;if(typeof ActiveXObject!=="undefined")try{obj=new ActiveXObject("Microsoft.XMLHTTP");result=true}catch(e){}return result}(),android:function(){return!server&&
regex.android.test(navigator.userAgent)}(),blackberry:function(){return!server&&regex.blackberry.test(navigator.userAgent)}(),chrome:function(){return!server&&regex.chrome.test(navigator.userAgent)}(),firefox:function(){return!server&&regex.firefox.test(navigator.userAgent)}(),ie:function(){return!server&&regex.ie.test(navigator.userAgent)}(),ios:function(){return!server&&regex.ios.test(navigator.userAgent)}(),linux:function(){return!server&&regex.linux.test(navigator.userAgent)}(),mobile:function(){var size;
if(server)return false;else{size=client.size();return/blackberry|iphone|webos/i.test(navigator.userAgent)||regex.android.test(navigator.userAgent)&&(size[0]<720||size[1]<720)}},playbook:function(){return!server&&regex.playbook.test(navigator.userAgent)}(),opera:function(){return!server&&regex.opera.test(navigator.userAgent)}(),osx:function(){return!server&&regex.osx.test(navigator.userAgent)}(),safari:function(){return!server&&regex.safari.test(navigator.userAgent.replace(/chrome.*/i,""))}(),tablet:function(){var size;
if(server)return false;else{size=client.size();return/ipad|playbook|webos/i.test(navigator.userAgent)||regex.android.test(navigator.userAgent)&&(size[0]>=720||size[1]>=720)}},webos:function(){return!server&&regex.webos.test(navigator.userAgent)}(),windows:function(){return!server&&regex.windows.test(navigator.userAgent)}(),version:function(){var version=0;if(this.chrome)version=navigator.userAgent.replace(/(.*chrome\/|safari.*)/gi,"");else if(this.firefox)version=navigator.userAgent.replace(/(.*firefox\/)/gi,
"");else if(this.ie){version=number.parse(navigator.userAgent.replace(/(.*msie|;.*)/gi,""),10);if(document.documentMode<version)version=document.documentMode}else if(this.opera)version=navigator.userAgent.replace(/(.*version\/|\(.*)/gi,"");else if(this.safari)version=navigator.userAgent.replace(/(.*version\/|safari.*)/gi,"");else version=navigator!==undefined?navigator.appVersion:0;version=number.parse(string.trim(version));if(isNaN(version))version=0;return version},allows:function(uri,verb){if(string.isEmpty(uri)||
string.isEmpty(verb))throw new Error(label.error.invalidArguments);uri=utility.parse(uri).href;verb=verb.toLowerCase();var result=false,bit=0;if(!cache.get(uri,false))result=undefined;else{if(regex.del.test(verb))bit=1;else if(regex.get_headers.test(verb))bit=4;else if(regex.put_post.test(verb))bit=2;else if(regex.patch.test(verb))bit=8;result=Boolean(client.permissions(uri,verb).bit&bit)}return result},bit:function(args){var result=0;array.each(args,function(verb){verb=verb.toLowerCase();if(regex.get_headers.test(verb))result|=
4;else if(regex.put_post.test(verb))result|=2;else if(regex.patch.test(verb))result|=8;else if(regex.del.test(verb))result|=1});return result},cors:function(uri){return!server&&(uri.indexOf("//")>-1&&uri.indexOf("//"+location.host)===-1)},headers:function(xhr,uri,type){var headers=string.trim(xhr.getAllResponseHeaders()).split("\n"),items={},o={},allow=null,expires=new Date,cors=client.cors(uri);array.each(headers,function(i){var header,value;value=i.replace(regex.header_value_replace,"");header=
i.replace(regex.header_replace,"");header=string.unhyphenate(header,true).replace(/\s+/g,"-");items[header]=value;if(allow===null)if(!cors&&regex.allow.test(header)||cors&&regex.allow_cors.test(header))allow=value});if(regex.no.test(items["Cache-Control"]));else if(items["Cache-Control"]!==undefined&&regex.number_present.test(items["Cache-Control"]))expires=expires.setSeconds(expires.getSeconds()+number.parse(regex.number_present.exec(items["Cache-Control"])[0],10));else if(items.Expires!==undefined)expires=
new Date(items.Expires);else expires=expires.setSeconds(expires.getSeconds()+abaaso.expires);o.expires=expires;o.headers=items;o.permission=client.bit(allow!==null?string.explode(allow):[type]);if(type==="get"){cache.set(uri,"expires",o.expires);cache.set(uri,"headers",o.headers);cache.set(uri,"permission",o.permission)}return o},parse:function(xhr,type){type=type||"";var result,obj;if((regex.json_maybe.test(type)||string.isEmpty(type))&&(regex.json_wrap.test(xhr.responseText)&&Boolean(obj=json.decode(xhr.responseText,
true))))result=obj;else if(regex.xml.test(type)){if(type!=="text/xml")xhr.overrideMimeType("text/xml");result=xhr.responseXML}else if(type==="text/plain"&&(regex.is_xml.test(xhr.responseText)&&xml.valid(xhr.responseText)))result=xml.decode(xhr.responseText);else result=xhr.responseText;return result},permissions:function(uri){var cached=cache.get(uri,false),bit=!cached?0:cached.permission,result={allows:[],bit:bit,map:{partial:8,read:4,write:2,"delete":1,unknown:0}};if(bit&1)result.allows.push("DELETE");
if(bit&2){result.allows.push("POST");result.allows.push("PUT")}if(bit&4)result.allows.push("GET");if(bit&8)result.allows.push("PATCH");return result},jsonp:function(uri,success,failure,args){var defer=deferred(),callback="callback",cbid,s;if(external===undefined){if(global.abaaso===undefined)utility.define("abaaso.callback",{},global);external="abaaso"}if(args instanceof Object&&args.callback!==undefined)callback=args.callback;defer.then(function(arg){if(typeof success==="function")success(arg)},
function(e){if(typeof failure==="function")failure(e);throw e;});do cbid=utility.genId().slice(0,10);while(global.abaaso.callback[cbid]!==undefined);uri=uri.replace(callback+"=?",callback+"="+external+".callback."+cbid);global.abaaso.callback[cbid]=function(arg){clearTimeout(utility.timer[cbid]);delete utility.timer[cbid];delete global.abaaso.callback[cbid];defer.resolve(arg);element.destroy(s)};s=element.create("script",{src:uri,type:"text/javascript"},utility.dom("head")[0]);utility.defer(function(){defer.reject(undefined)},
3E4,cbid);return defer},request:function(uri,type,success,failure,args,headers,timeout){timeout=timeout||3E4;var cors,xhr,payload,cached,typed,contentType,doc,ab,blob,defer;if(regex.put_post.test(type)&&args===undefined)throw new Error(label.error.invalidArguments);uri=utility.parse(uri).href;type=type.toLowerCase();headers=headers instanceof Object?headers:null;cors=client.cors(uri);xhr=!client.ie||type!=="patch"?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");payload=(regex.put_post.test(type)||
regex.patch.test(type))&&args!==undefined?args:null;cached=type==="get"?cache.get(uri):false;typed=type.capitalize();contentType=null;doc=typeof Document!=="undefined";ab=typeof ArrayBuffer!=="undefined";blob=typeof Blob!=="undefined";defer=deferred();defer.then(function(arg){if(typeof success==="function")success.call(uri,arg,xhr);xhr=null},function(e){if(typeof failure==="function")failure.call(uri,e,xhr);xhr=null;throw e;});uri.fire("before"+typed);if(!cors&&(!regex.get_headers.test(type)&&client.allows(uri,
type)===false)){xhr.status=405;defer.reject(null);return uri.fire("failed"+typed,null,xhr)}if(type==="get"&&Boolean(cached)){if(server){xhr.readyState=4;xhr.status=200;xhr._resheaders=cached.headers}defer.resolve(cached.response);uri.fire("afterGet",cached.response,xhr)}else{xhr[typeof xhr.onreadystatechange!=="undefined"?"onreadystatechange":"onload"]=function(){client.response(xhr,uri,type,defer)};try{if(xhr.timeout!==undefined)xhr.timeout=timeout}catch(e){}if(xhr.ontimeout!==undefined)xhr.ontimeout=
function(e){uri.fire("timeout"+typed,e,xhr)};if(xhr.onprogress!==undefined)xhr.onprogress=function(e){uri.fire("progress"+typed,e,xhr)};if(xhr.upload!==undefined&&xhr.upload.onprogress!==undefined)xhr.upload.onprogress=function(e){uri.fire("progressUpload"+typed,e,xhr)};xhr.open(type.toUpperCase(),uri,true);if(headers!==null&&headers.hasOwnProperty("Content-Type"))contentType=headers["Content-Type"];if(cors&&contentType===null)contentType="text/plain";if(payload!==null){if(payload.hasOwnProperty("xml"))payload=
payload.xml;if(doc&&payload instanceof Document)payload=xml.decode(payload);if(typeof payload==="string"&&regex.is_xml.test(payload))contentType="application/xml";if(!(ab&&payload instanceof ArrayBuffer)&&(!(blob&&payload instanceof Blob)&&payload instanceof Object)){contentType="application/json";payload=json.encode(payload)}if(contentType===null&&(ab&&payload instanceof ArrayBuffer||blob&&payload instanceof Blob))contentType="application/octet-stream";if(contentType===null)contentType="application/x-www-form-urlencoded; charset=UTF-8"}if(typeof xhr.setRequestHeader!==
"undefined"){if(typeof cached==="object"&&cached.headers.hasOwnProperty("ETag"))xhr.setRequestHeader("ETag",cached.headers.ETag);if(headers===null)headers={};if(contentType!==null)headers["Content-Type"]=contentType;if(headers.hasOwnProperty("callback"))delete headers.callback;utility.iterate(headers,function(v,k){if(v!==null&&k!=="withCredentials")xhr.setRequestHeader(k,v)})}if(typeof xhr.withCredentials==="boolean"&&(headers!==null&&typeof headers.withCredentials==="boolean"))xhr.withCredentials=
headers.withCredentials;payload!==null?xhr.send(payload):xhr.send()}defer.xhr=xhr;return defer},response:function(xhr,uri,type,defer){var typed=string.capitalize(type.toLowerCase()),xhrState=null,shared=true,exception,o,r,t,redirect;exception=function(e,xhr){defer.reject(e);utility.error(e,arguments,this,true);uri.fire("failed"+typed,client.parse(xhr),xhr)};if(xhr.readyState===2)uri.fire("received"+typed,null,xhr);else if(xhr.readyState===4){switch(xhr.status){case 200:case 201:case 202:case 203:case 204:case 205:case 206:o=
client.headers(xhr,uri,type);uri.fire("headers",o.headers,xhr);if(type==="head"){defer.resolve(o.headers);return uri.fire("afterHead",o.headers)}else if(type==="options"){defer.resolve(o.headers);return uri.fire("afterOptions",o.headers)}else if(type!=="delete"){if(server&&regex.priv.test(o.headers["Cache-Control"]))shared=false;if(regex.http_body.test(xhr.status)){t=o.headers["Content-Type"]||"";r=client.parse(xhr,t);if(r===undefined)throw new Error(label.error.serverError);}if(type==="get"&&shared)cache.set(uri,
"response",o.response=utility.clone(r,true));else cache.expire(uri,true)}else if(type==="delete")cache.expire(uri,true);if(state.getHeader()!==null&&(Boolean(xhrState=o.headers[state.getHeader()])&&state.current!==xhrState))state.setCurrent(state);switch(xhr.status){case 200:case 202:case 203:case 206:defer.resolve(r);uri.fire("after"+typed,r,xhr);break;case 201:if((o.headers.Location===undefined||string.isEmpty(o.headers.Location))&&!string.isUrl(r))exception(new Error(label.error.invalidArguments),
xhr);else{redirect=string.trim(o.headers.Location||r);client.request(redirect,"GET",function(arg){defer.resolve(arg);uri.fire("after"+typed,arg,xhr)},function(e){exception(e,xhr)});break}break;case 204:defer.resolve(null);uri.fire("after"+typed,null,xhr);break;case 205:defer.resolve(null);uri.fire("reset",null,xhr);break}break;case 304:defer.resolve(r);uri.fire("after"+typed,r,xhr);break;case 401:exception(!server?new Error(label.error.serverUnauthorized):label.error.serverUnauthorized,xhr);break;
case 403:cache.set(uri,"!permission",client.bit([type]));exception(!server?new Error(label.error.serverForbidden):label.error.serverForbidden,xhr);break;case 405:cache.set(uri,"!permission",client.bit([type]));exception(!server?new Error(label.error.serverInvalidMethod):label.error.serverInvalidMethod,xhr);break;default:exception(!server?new Error(label.error.serverError):label.error.serverError,xhr);break}try{xhr.onreadystatechange=null}catch(e){}}},script:function(arg,target,pos){return element.create("script",
{type:"application/javascript",src:arg},target||utility.dom("head")[0],pos)},scroll:function(dest,ms){var defer=deferred(),start=client.scrollPos(),t=0;ms=(!isNaN(ms)?ms:250)/100;utility.repeat(function(){var pos=math.bezier(start[0],start[1],dest[0],dest[1],++t/100);window.scrollTo(pos[0],pos[1]);if(t===100){defer.resolve(true);return false}},ms,"scrolling");return defer},scrollPos:function(){return[window.scrollX||0,window.scrollY||0]},size:function(){return[document["documentElement"||"body"].clientWidth||
0,document["documentElement"||"body"].clientHeight||0]},stylesheet:function(arg,media){return element.create("link",{rel:"stylesheet",type:"text/css",href:arg,media:media||"print, screen"},utility.dom("head")[0])}};var cookie={expire:function(name,domain,secure,path,jar){cookie.set(name,"","-1s",domain,secure,path,jar);return name},get:function(name,jar){return utility.coerce(cookie.list(jar)[name])},list:function(jar){var result={};if(jar===undefined)jar=server?"":document.cookie;if(!string.isEmpty(jar))array.each(string.explode(jar,
";"),function(i){var item=string.explode(i,"=");result[item[0]]=utility.coerce(item[1])});return result},set:function(name,value,offset,domain,secure,path,jar){value=(value||"")+";";offset=offset||"";domain=typeof domain==="string"?" Domain="+domain+";":"";secure=secure===true?" secure":"";path=typeof path==="string"?" Path="+path+";":"";var expire="",span=null,type=null,types=["d","h","m","s"],regex=new RegExp,i=types.length,cookies;if(!string.isEmpty(offset)){while(i--){utility.compile(regex,types[i]);
if(regex.test(offset)){type=types[i];span=number.parse(offset,10);break}}if(isNaN(span))throw new Error(label.error.invalidArguments);expire=new Date;if(type==="d")expire.setDate(expire.getDate()+span);else if(type==="h")expire.setHours(expire.getHours()+span);else if(type==="m")expire.setMinutes(expire.getMinutes()+span);else if(type==="s")expire.setSeconds(expire.getSeconds()+span)}if(expire instanceof Date)expire=" Expires="+expire.toUTCString()+";";if(!server)document.cookie=string.trim(name.toString())+
"="+value+expire+domain+path+secure;else{cookies=jar.getHeader("Set-Cookie")||[];cookies.push((string.trim(name.toString())+"="+value+expire+domain+path+secure).replace(/;$/,""));jar.setHeader("Set-Cookie",cookies)}}};var datastore={decorator:function(obj,recs,args){utility.genId(obj);if(typeof obj.fire!=="function")observer.decorate(obj);obj.data=new DataStore(obj);abaaso.datastores[obj.data.id]=obj.data;if(args instanceof Object)utility.merge(obj.data,args);if(recs!==null&&typeof recs==="object")obj.data.batch("set",
recs);return obj},worker:function(ev){var cmd=ev.data.cmd,clauses,cond,result,where;if(cmd==="select"){where=JSON.parse(ev.data.where);clauses=array.fromObject(where);cond="return ( ";if(clauses.length>1)array.each(clauses,function(i,idx){var b1="( ";if(idx>0)b1=" && ( ";if(i[1]instanceof Function)cond+=b1+i[1].toString()+'( rec.data["'+i[0]+'"] ) )';else if(!isNaN(i[1]))cond+=b1+'rec.data["'+i[0]+'"] === '+i[1]+" )";else cond+=b1+'rec.data["'+i[0]+'"] === "'+i[1]+'" )'});else if(clauses[0][1]instanceof
Function)cond+=clauses[0][1].toString()+'( rec.data["'+clauses[0][0]+'"] )';else if(!isNaN(clauses[0][1]))cond+='rec.data["'+clauses[0][0]+'"] === '+clauses[0][1];else cond+='rec.data["'+clauses[0][0]+'"] === "'+clauses[0][1]+'"';cond+=" );";result=ev.data.records.filter(new Function("rec",cond))}else if(cmd==="sort")result=array.keySort(ev.data.records,ev.data.query,"data");postMessage(result)}};function DataStore(obj){this.autosave=false;this.callback=null;this.collections=[];this.credentials=null;
this.datalists=[];this.depth=0;this.events=false;this.expires=null;this.headers={Accept:"application/json"};this.id=utility.uuid();this.ignore=[];this.key=null;this.keys={};this.leafs=[];this.loaded=false;this.maxDepth=0;this.mongodb="";this.parentNode=obj;this.pointer=null;this.records=[];this.retrieve=false;this.source=null;this.total=0;this.views={};this.uri=null}DataStore.prototype.constructor=DataStore;DataStore.prototype.batch=function(type,data,sync){if(!regex.set_del.test(type)||(sync&&regex.del.test(type)||
typeof data!=="object"))throw new Error(label.error.invalidArguments);sync=sync===true;var self=this,events=this.events,defer=deferred(),deferreds=[];if(events)observer.fire(self.parentNode,"beforeDataBatch",data);if(sync)this.clear(sync);if(data.length===0)defer.resolve(this.records);else{if(type==="del")array.each(data,function(i){deferreds.push(self.del(i,false,true))});else array.each(data,function(i){deferreds.push(self.set(null,i,true))});utility.when(deferreds).then(function(){self.loaded=
true;if(events)observer.fire(self.parentNode,"afterDataBatch",self.records);array.each(self.datalists,function(i){i.refresh(true)});if(type==="del")self.reindex();if(self.autosave)self.save();defer.resolve(self.records)},function(e){observer.fire(self.parentNode,"failedDataBatch",e);defer.reject(e)})}return defer};DataStore.prototype.buildUri=function(key){var parsed=utility.parse(this.uri);return parsed.protocol+"//"+parsed.host+parsed.pathname+(regex.endslash.test(parsed.pathname)?"":"/")+key};
DataStore.prototype.clear=function(sync){sync=sync===true;var events=this.events===true;if(!sync){if(events)observer.fire(this.parentNode,"beforeDataClear");array.each(this.datalists,function(i){i.teardown(true)});this.autosave=false;this.callback=null;this.collections=[];this.credentials=null;this.datalists=[];this.depth=0;this.events=true;this.expires=null;this.headers={Accept:"application/json"};this.ignore=[];this.key=null;this.keys={};this.leafs=[];this.loaded=false;this.maxDepth=0;this.pointer=
null;this.records=[];this.retrieve=false;this.source=null;this.total=0;this.views={};this.uri=null;if(events)observer.fire(this.parentNode,"afterDataClear")}else{this.collections=[];this.keys={};this.loaded=false;this.records=[];this.total=0;this.views={};array.each(this.datalists,function(i){i.refresh(true,true)})}return this};DataStore.prototype.crawl=function(arg){var self=this,events=this.events===true,record=arg instanceof Object?arg:this.get(arg),defer=deferred(),deferreds=[],parsed=utility.parse(this.uri||
"");if(this.uri===null||record===undefined)throw new Error(label.error.invalidArguments);if(events)observer.fire(this.parentNode,"beforeDataRetrieve",record);utility.iterate(record.data,function(v,k){var uri;if(array.contains(self.ignore,k)||(array.contains(self.leafs,k)||(self.depth>=self.maxDepth||(!(v instanceof Array)&&typeof v!=="string"||v.indexOf("//")===-1&&v.charAt(0)!=="/"))))return;array.add(self.collections,k);record.data[k]=datastore.decorator({id:record.key+"-"+k},null,{key:self.key,
pointer:self.pointer,source:self.source,ignore:self.ignore.slice(),leafs:self.leafs.slice(),depth:self.depth+1,maxDepth:self.maxDepth,headers:self.headers,retrieve:true});if(!array.contains(self.leafs,k)&&(record.data[k].data.maxDepth===0||record.data[k].data.depth<=record.data[k].data.maxDepth))if(v instanceof Array)deferreds.push(record.data[k].data.batch("set",v));else{if(v.indexOf("//")===-1)if(v.charAt(0)!=="/")uri=self.buildUri(v);else uri=parsed.protocol+"//"+parsed.host+v;else uri=v;deferreds.push(record.data[k].data.setUri(uri))}});
if(deferreds.length>0)utility.when(deferreds).then(function(){if(events)observer.fire(self.parentNode,"afterDataRetrieve",record);defer.resolve(record)},function(e){if(events)observer.fire(self.parentNode,"failedDataRetrieve",record);defer.reject(e)});else{if(events)observer.fire(self.parentNode,"afterDataRetrieve",record);defer.resolve(record)}return defer};DataStore.prototype.del=function(record,reindex,batch){record=record.key?record:this.get(record);reindex=reindex!==false;batch=batch===true;
var self=this,defer=deferred();if(record===undefined)defer.reject(new Error(label.error.invalidArguments));else{if(this.events)observer.fire(self.parentNode,"beforeDataDelete",record);if(this.uri===null||this.callback!==null)this.delComplete(record,reindex,batch,defer);else client.request(this.buildUri(record.key),"DELETE",function(){self.delComplete(record,reindex,batch,defer)},function(e){observer.fire(self.parentNode,"failedDataDelete",e);defer.reject(e)},undefined,utility.merge({withCredentials:this.credentials},
this.headers))}return defer};DataStore.prototype.delComplete=function(record,reindex,batch,defer){delete this.keys[record.key];this.records.remove(record.index);this.total--;this.views={};array.each(this.collections,function(i){record.data[i].teardown()});if(!batch){if(reindex)this.reindex();if(this.autosave)this.purge(record.key);if(this.events)observer.fire(this.parentNode,"afterDataDelete",record)}defer.resolve(record.key);return this};DataStore.prototype.dump=function(args,fields){args=args||
this.records;var self=this,custom=fields instanceof Array&&fields.length>0,fn;if(custom)fn=function(i){var record={};array.each(fields,function(f){record[f]=f===self.key?i.key:!array.contains(self.collections,f)?utility.clone(i.data[f],true):i.data[f].data.uri});return record};else fn=function(i){var record={};record[self.key]=i.key;utility.iterate(i.data,function(v,k){record[k]=!array.contains(self.collections,k)?utility.clone(v,true):v.data.uri});return record};return args.map(fn)};DataStore.prototype.get=
function(record,offset){var records=this.records,type=typeof record,self=this,r;if(type==="undefined")r=records;else if(type==="string")if(record.indexOf(",")===-1)r=records[self.keys[record]];else r=string.explode(record).map(function(i){if(!isNaN(i))return records[parseInt(i,10)];else return records[self.keys[i]]});else if(type==="number")if(isNaN(offset))r=records[parseInt(record,10)];else r=array.limit(records,parseInt(record,10),parseInt(offset,10));return r},DataStore.prototype.join=function(arg,
field,join){join=join||"inner";var self=this,defer=deferred(),results=[],deferreds=[],key=field===this.key,keys=array.merge(array.cast(this.records[0].data,true),array.cast(arg.records[0].data,true)),fn;if(join==="inner")fn=function(i){var where={},record=utility.clone(i.data,true),defer=deferred();where[field]=key?i.key:record[field];arg.select(where).then(function(match){if(match.length>2)defer.reject(new Error(label.error.databaseMoreThanOne));else if(match.length===1){results.push(utility.merge(record,
match[0].data));defer.resolve(true)}else defer.resolve(false)});deferreds.push(defer)};else if(join==="left")fn=function(i){var where={},record=utility.clone(i.data,true),defer=deferred();where[field]=key?i.key:record[field];arg.select(where).then(function(match){if(match.length>2)defer.reject(new Error(label.error.databaseMoreThanOne));else if(match.length===1){results.push(utility.merge(record,match[0].data));defer.resolve(true)}else{array.each(keys,function(i){if(record[i]===undefined)record[i]=
null});results.push(record);defer.resolve(true)}});deferreds.push(defer)};else if(join==="right")fn=function(i){var where={},record=utility.clone(i.data,true),defer=deferred();where[field]=key?i.key:record[field];self.select(where).then(function(match){if(match.length>2)defer.reject(new Error(label.error.databaseMoreThanOne));else if(match.length===1){results.push(utility.merge(record,match[0].data));defer.resolve(true)}else{array.each(keys,function(i){if(record[i]===undefined)record[i]=null});results.push(record);
defer.resolve(true)}});deferreds.push(defer)};array.each(join==="right"?arg.records:this.records,fn);utility.when(deferreds).then(function(){defer.resolve(results)},function(e){defer.reject(e)});return defer};DataStore.prototype.only=function(arg){if(arg===this.key)return this.records.map(function(i){return i.key});else return this.records.map(function(i){return i.data[arg]})};DataStore.prototype.purge=function(arg){return this.storage(arg||this,"remove")};DataStore.prototype.reindex=function(){var nth=
this.total,i=-1;this.views={};if(nth>0)while(++i<nth){this.records[i].index=i;this.keys[this.records[i].key]=i}return this};DataStore.prototype.restore=function(arg){return this.storage(arg||this,"get")};DataStore.prototype.save=function(arg){return this.storage(arg||this,"set")};DataStore.prototype.select=function(where){var defer=deferred(),blob,clauses,cond,functions,worker;if(!(where instanceof Object))throw new Error(label.error.invalidArguments);if(server){clauses=array.fromObject(where);cond=
"return ( ";if(clauses.length>1)array.each(clauses,function(i,idx){var b1="( ";if(idx>0)b1=" && ( ";if(i[1]instanceof Function)cond+=b1+i[1].toString()+'( rec.data["'+i[0]+'"] ) )';else if(!isNaN(i[1]))cond+=b1+'rec.data["'+i[0]+'"] === '+i[1]+" )";else cond+=b1+'rec.data["'+i[0]+'"] === "'+i[1]+'" )'});else if(clauses[0][1]instanceof Function)cond+=clauses[0][1].toString()+'( rec.data["'+clauses[0][0]+'"] )';else if(!isNaN(clauses[0][1]))cond+='rec.data["'+clauses[0][0]+'"] === '+clauses[0][1];else cond+=
'rec.data["'+clauses[0][0]+'"] === "'+clauses[0][1]+'"';cond+=" );";defer.resolve(this.records.slice().filter(new Function("rec",cond)))}else{functions=[];utility.iterate(where,function(v,k){if(typeof v==="function"){this[k]=v.toString();functions.push(k)}});blob=new Blob([WORKER]);worker=new Worker(global.URL.createObjectURL(blob));worker.onmessage=function(ev){defer.resolve(ev.data)};worker.postMessage({cmd:"select",records:this.records,where:json.encode(where),functions:functions})}return defer};
DataStore.prototype.set=function(key,data,batch){data=utility.clone(data,true);batch=batch===true;var self=this,events=this.events,defer=deferred(),record=key!==null?this.get(key)||null:null,method="POST",parsed=utility.parse(self.uri||""),uri;if(typeof data==="string"){if(data.indexOf("//")===-1)if(data.charAt(0)!=="/")uri=this.buildUri(data);else if(self.uri!==null&&regex.root.test(data))uri=parsed.protocol+"//"+parsed.host+data;else uri=data;else uri=data;key=uri.replace(regex.not_endpoint,"");
if(string.isEmpty(key))defer.reject(new Error(label.error.invalidArguments));else{if(!batch&&events)observer.fire(self.parentNode,"beforeDataSet",{key:key,data:data});client.request(uri,"GET",function(arg){self.setComplete(record,key,self.source?arg[self.source]:arg,batch,defer)},function(e){observer.fire(self.parentNode,"failedDataSet",e);defer.reject(e)},undefined,utility.merge({withCredentials:self.credentials},self.headers))}}else{if(record===null&&(key===null||key===undefined))if(this.key===
null)key=utility.uuid();else if(data[this.key]){key=data[this.key];delete data[this.key]}else key=utility.uuid();if(!batch&&events)observer.fire(self.parentNode,"beforeDataSet",{key:key,data:data});if(batch||this.uri===null)this.setComplete(record,key,data,batch,defer);else{if(key!==null){method="PUT";uri=this.buildUri(key);if(client.allows(uri,"patch")&&(!client.ie||client.activex))method="PATCH";else if(record!==null)utility.iterate(record.data,function(v,k){if(!array.contains(self.collections,
k)&&!data[k])data[k]=v})}else uri=this.uri;client.request(uri,method,function(arg){self.setComplete(record,key,self.source?arg[self.source]:arg,batch,defer)},function(e){observer.fire(self.parentNode,"failedDataSet",e);defer.reject(e)},data,utility.merge({withCredentials:this.credentials},this.headers))}}return defer};DataStore.prototype.setComplete=function(record,key,data,batch,defer){var self=this,deferreds=[];if(record===null){record={index:this.total++,key:key,data:data};this.keys[key]=record.index;
this.records[record.index]=record;if(this.retrieve)deferreds.push(this.crawl(record))}else utility.iterate(data,function(v,k){if(!array.contains(self.collections,k))record.data[k]=v;else if(typeof v==="string")deferreds.push(record.data[k].data.setUri(record.data[k].data.uri+"/"+v,true));else deferreds.push(record.data[k].data.batch("set",v,true))});if(!batch&&this.events)observer.fire(self.parentNode,"afterDataSet",record);if(deferreds.length===0)defer.resolve(record);else utility.when(deferreds).then(function(){defer.resolve(record)});
return this};DataStore.prototype.setExpires=function(arg){if(arg!==null&&this.uri===null||arg!==null&&(isNaN(arg)||arg<1E3))throw new Error(label.error.invalidArguments);if(this.expires===arg)return;this.expires=arg;var id=this.parentNode.id+"DataExpire",expires=arg,self=this;utility.clearTimers(id);if(arg===null)return;utility.repeat(function(){if(self.uri===null){self.setExpires(null);return false}if(!cache.expire(self.uri))observer.fire(self.uri,"beforeExpire, expire, afterExpire")},expires,id,
false)};DataStore.prototype.setUri=function(arg){var defer=deferred();if(arg!==null&&string.isEmpty(arg))throw new Error(label.error.invalidArguments);arg=utility.parse(arg).href;if(this.uri===arg)defer.resolve(this.records);else{if(this.uri!==null)observer.remove(this.uri);this.uri=arg;if(this.uri!==null){observer.add(this.uri,"expire",function(){this.sync()},"dataSync",this);cache.expire(this.uri,true);this.sync().then(function(arg){defer.resolve(arg)},function(e){defer.reject(e)})}}return defer};
DataStore.prototype.sort=function(query,create,where){create=create===true||where instanceof Object;var self=this,view=string.explode(query).join(" ").toCamelCase(),defer=deferred(),blob,next,worker;next=function(records){if(self.total===0)defer.resolve([]);else if(!create&&self.views[view])defer.resolve(self.views[view]);else if(server){self.views[view]=array.keySort(records.slice(),query,"data");defer.resolve(self.views[view])}else{blob=new Blob([WORKER]);worker=new Worker(global.URL.createObjectURL(blob));
worker.onmessage=function(ev){self.views[view]=ev.data;defer.resolve(self.views[view])};worker.postMessage({cmd:"sort",records:records.slice(),query:query})}};if(!where)next(this.records);else this.select(where).then(next);return defer};DataStore.prototype.storage=function(obj,op,type){var self=this,record=false,mongo=!string.isEmpty(this.mongodb),session=type==="session"&&typeof sessionStorage!=="undefined",defer=deferred(),data,deferreds,key,result;if(!regex.number_string_object.test(typeof obj)||
!regex.get_remove_set.test(op))throw new Error(label.error.invalidArguments);record=regex.number_string.test(typeof obj)||obj.hasOwnProperty("key")&&!obj.hasOwnProperty("parentNode");if(op!=="remove"){if(record&&!(obj instanceof Object))obj=this.get(obj);key=record?obj.key:obj.parentNode.id}else if(op==="remove"&&record)key=obj.key||obj;if(op==="get")if(mongo)mongodb.connect(this.mongodb,function(e,db){if(e){defer.reject(e);db.close()}else db.createCollection(self.parentNode.id,function(e,collection){if(e){defer.reject(e);
db.close()}else if(record)collection.find({_id:obj.key}).limit(1).toArray(function(e,recs){if(e)defer.reject(e);else{delete recs[0]._id;self.set(key,recs[0],true).then(function(rec){defer.resolve(rec)},function(e){defer.reject(e)})}db.close()});else collection.find({}).toArray(function(e,recs){var i=-1,nth=recs.length;if(e)defer.reject(e);else{if(nth>0){self.records=recs.map(function(r){var rec={key:r._id,index:++i,data:{}};self.keys[rec.key]=rec.index;rec.data=r;delete rec.data._id;return rec});
self.total=nth}defer.resolve(self.records)}db.close()})})});else{result=session?sessionStorage.getItem(key):localStorage.getItem(key);if(result!==null){result=json.decode(result);if(record)self.set(key,result,true).then(function(rec){defer.resolve(rec)},function(e){defer.reject(e)});else{utility.merge(self,result);defer.resolve(self)}}else defer.resolve(self)}else if(op==="remove")if(mongo)mongodb.connect(this.mongodb,function(e,db){if(e){defer.reject(e);db.close()}else db.createCollection(self.parentNode.id,
function(e,collection){collection.remove(record?{_id:key}:{},{safe:true},function(e,arg){if(e)defer.reject(e);else defer.resolve(arg);db.close()})})});else{session?sessionStorage.removeItem(key):localStorage.removeItem(key);defer.resolve(this)}else if(op==="set")if(mongo)mongodb.connect(this.mongodb,function(e,db){if(e){defer.reject(e);db.close()}else db.createCollection(self.parentNode.id,function(e,collection){if(e){defer.reject(e);db.close()}else if(record)collection.update({_id:obj.key},{$set:obj.data},
{w:1,safe:true,upsert:true},function(e,arg){if(e)defer.reject(e);else defer.resolve(arg);db.close()});else collection.remove({},{w:1,safe:true},function(e){if(e){defer.reject(e);db.close()}else{deferreds=[];array.each(self.records,function(i){var data={},defer2=deferred();deferreds.push(defer2);utility.iterate(i.data,function(v,k){if(!array.contains(self.collections,k))data[k]=v});collection.update({_id:i.key},{$set:data},{w:1,safe:true,upsert:true},function(e,arg){if(e)defer2.reject(e);else defer2.resolve(arg)})});
utility.when(deferreds).then(function(result){defer.resolve(result);db.close()},function(e){defer.reject(e);db.close()})}})})});else{data=json.encode(record?obj.data:{total:this.total,keys:this.keys,records:this.records});session?sessionStorage.setItem(key,data):localStorage.setItem(key,data);defer.resolve(this)}return defer};DataStore.prototype.sync=function(){if(this.uri===null||string.isEmpty(this.uri))throw new Error(label.error.invalidArguments);var self=this,events=this.events===true,defer=
deferred(),success,failure;success=function(arg){var data;if(typeof arg!=="object")throw new Error(label.error.expectedObject);if(self.source!==null)arg=utility.walk(arg,self.source);if(arg instanceof Array)data=arg;else data=[arg];self.batch("set",data,true).then(function(arg){if(events)observer.fire(self.parentNode,"afterDataSync",arg);defer.resolve(arg)},failure)};failure=function(e){if(events)observer.fire(self.parentNode,"failedDataSync",e);defer.reject(e)};if(events)observer.fire(this.parentNode,
"beforeDataSync",this.uri);if(this.callback!==null)client.jsonp(this.uri,success,failure,{callback:this.callback});else client.request(this.uri,"GET",success,failure,null,utility.merge({withCredentials:this.credentials},this.headers));return defer};DataStore.prototype.teardown=function(){var uri=this.uri,id;if(uri!==null){cache.expire(uri,true);observer.remove(uri);id=this.parentNode.id+"DataExpire";utility.clearTimers(id);array.each(this.records,function(i){var recordUri=uri+"/"+i.key;cache.expire(recordUri,
true);observer.remove(recordUri);utility.iterate(i.data,function(v){if(v===null)return;if(v.data&&typeof v.data.teardown==="function"){observer.remove(v.id);v.data.teardown()}})})}delete abaaso.datastores[this.id];array.each(this.datalists,function(i){i.teardown()});this.clear(true);observer.fire(this.parentNode,"afterDataTeardown");return this};DataStore.prototype.unique=function(key){return array.unique(this.records.map(function(i){return i.data[key]}))};DataStore.prototype.update=function(key,
data){var record=this.get(key),defer=deferred();if(record===undefined)throw new Error(label.error.invalidArguments);utility.iterate(record.data,function(v,k){data[v]=k});this.set(key,data).then(function(arg){defer.resolve(arg)},function(e){defer.reject(e)});return defer};var datalist={factory:function(target,store,template,options){var ref=[store],obj,instance;if(!(target instanceof Element)||(typeof store!=="object"||!regex.string_object.test(typeof template)))throw new Error(label.error.invalidArguments);
obj=element.create("ul",{"class":"list",id:store.parentNode.id+"-datalist"},target);instance=new DataList(obj,ref[0],template);if(options instanceof Object)utility.merge(instance,options);instance.store.datalists.push(instance);if(instance.store.uri===null||instance.store.loaded)instance.refresh(true);return instance},pages:function(){if(isNaN(this.pageSize))throw new Error(label.error.invalidArguments);return number.round(this.total/this.pageSize,"up")},range:function(){var start=this.pageIndex*
this.pageSize-this.pageSize,end=this.pageSize;return[start,end]}};function DataList(element,store,template){this.callback=null;this.element=element;this.emptyMsg="Nothing to display";this.filter=null;this.id=utility.genId();this.pageIndex=1;this.pageSize=null;this.pageRange=5;this.pagination="bottom";this.placeholder="";this.order="";this.records=[];this.template=template;this.total=0;this.store=store;this.where=null}DataList.prototype.constructor=DataList;DataList.prototype.del=function(rec){if(typeof this.pageIndex===
"number"&&typeof this.pageSize==="number")this.refresh();else{observer.fire(this.element,"beforeDataListRefresh");array.each(this.element.find("> li[data-key='"+rec.key+"']"),function(i){element.destroy(i)});observer.fire(this.element,"afterDataListRefresh")}return this};DataList.prototype.dump=function(){return this.store.dump(this.records)};DataList.prototype.page=function(arg,redraw,create){this.pageIndex=arg;return this.refresh(redraw,create)};DataList.prototype.pages=function(){var obj=this.element,
page=this.pageIndex,pos=this.pagination,range=this.pageRange,mid=number.round(number.half(range),"down"),start=page-mid,end=page+mid,self=this,total=datalist.pages.call(this),diff;if(!regex.top_bottom.test(pos))throw new Error(label.error.invalidArguments);array.each(utility.dom("#"+obj.id+"-pages-top, #"+obj.id+"-pages-bottom"),function(i){if(i)element.destroy(i)});if(this.total===0||total===1)return this;if(start<1){diff=number.diff(start,1);start=start+diff;end=end+diff}if(end>total){end=total;
start=end-range+1;if(start<1)start=1}array.each(string.explode(pos),function(i){var current=false,more=page>1,next=page+1<=total,last=page>=total,el,n;el=element.create("ul",{"class":"list pages hidden "+i,id:obj.id+"-pages-"+i},obj,i==="bottom"?"after":"before");element.create(more?"a":"span",{"class":"first page","data-page":1,innerHTML:"&lt;&lt;"},element.create("li",{},el));element.create(more?"a":"span",{"class":"prev page","data-page":page-1,innerHTML:"&lt;"},element.create("li",{},el));for(n=
start;n<=end;n++){current=n===page;element.create(current?"span":"a",{"class":current?"current page":"page","data-page":n,innerHTML:n},element.create("li",{},el))}element.create(next?"a":"span",{"class":"next page","data-page":next?page+1:null,innerHTML:"&gt;"},element.create("li",{},el));element.create(last?"span":"a",{"class":"last page","data-page":last?null:total,innerHTML:"&gt;&gt;"},element.create("li",{},el));element.klass(el,"hidden",false);observer.add(el,"click",function(e){var target=utility.target(e);
utility.stop(e);if(target.nodeName==="A"){self.page(element.data(target,"page"));element.scrollTo(obj,100,-10)}},"pagination")});return this};DataList.prototype.refresh=function(redraw,create){redraw=redraw!==false;create=create===true;var el=this.element,template=typeof this.template==="object",items=[],self=this,callback=typeof this.callback==="function",reg=new RegExp,registry=[],limit=[],fn,ceiling,next;observer.fire(el,"beforeDataListRefresh");if(!template)fn=function(i){var html=self.template,
items=array.unique(html.match(/\{\{[\w\.\-\[\]]+\}\}/g));html=html.replace("{{"+self.store.key+"}}",i.key);array.each(items,function(attr){var key=attr.replace(/\{\{|\}\}/g,""),value=utility.walk(i.data,key);reg.compile(string.escape(attr),"g");html=html.replace(reg,value)});html=html.replace(/\{\{.*\}\}/g,self.placeholder);return'<li data-key="'+i.key+'">'+html+"</li>"};else fn=function(i){var obj=json.encode(self.template),items=array.unique(obj.match(/\{\{[\w\.\-\[\]]+\}\}/g));obj=obj.replace("{{"+
self.store.key+"}}",i.key);array.each(items,function(attr){var key=attr.replace(/\{\{|\}\}/g,""),value=utility.walk(i.data,key);reg.compile(string.escape(attr),"g");obj=obj.replace(reg,json.encode(value).replace(/(^")|("$)/g,""))});obj=json.decode(obj.replace(/\{\{.*\}\}/g,self.placeholder));return{li:obj}};next=function(consumed){array.each(consumed,function(i){if(self.filter===null||!(self.filter instanceof Object))items.push({key:i.key,template:fn(i)});else utility.iterate(self.filter,function(v,
k){var reg,key;if(array.contains(registry,i.key))return;v=string.explode(v);reg=new RegExp,key=k===self.store.key;array.each(v,function(query){var value=!key?utility.walk(i.data,k):"";utility.compile(reg,query,"i");if(key&&reg.test(i.key)||reg.test(value)){registry.push(i.key);items.push({key:i.key,template:fn(i)});return false}})})});self.records=items;self.total=items.length;if(typeof self.pageIndex==="number"&&typeof self.pageSize==="number"){ceiling=datalist.pages.call(self);if(ceiling>0&&self.pageIndex>
ceiling)return self.page(ceiling);else if(self.total>0){limit=datalist.range.call(self);items=items.limit(limit[0],limit[1])}}if(redraw)if(self.total===0)el.innerHTML='<li class="empty">'+self.emptyMsg+"</li>";else{el.innerHTML=items.map(function(i){return i.template}).join("\n");if(callback)array.each(element.find(el,"> li"),function(i){self.callback(i)})}else{array.each(element.find(el,"> li"),function(i){element.addClass(i,"hidden")});array.each(items,function(i){array.each(element.find(el,"> li[data-key='"+
i.key+"']"),function(o){element.removeClass(o,"hidden")})})}if(regex.top_bottom.test(self.pagination)&&(typeof self.pageIndex==="number"&&typeof self.pageSize==="number"))self.pages();else array.each(utility.dom("#"+el.id+"-pages-top, #"+el.id+"-pages-bottom"),function(i){element.destroy(i)});observer.fire(el,"afterDataListRefresh")};if(this.where===null)string.isEmpty(this.order)?next(this.store.get()):this.store.sort(this.order,create).then(next);else string.isEmpty(this.order)?this.store.select(this.where).then(next):
this.store.sort(this.order,create,this.where).then(next);return this};DataList.prototype.sort=function(order,create){this.order=order;return this.refresh(true,create)};DataList.prototype.teardown=function(destroy){destroy=destroy===true;var self=this,id=this.element.id;observer.remove(id);array.each(utility.dom("#"+id+"-pages-top, #"+id+"-pages-bottom"),function(i){observer.remove(i)});array.each(this.store.datalists,function(i,idx){if(i.id===self.id){this.remove(idx);return false}});if(destroy){element.destroy(this.element);
this.element=null}return this};var deferred=function(){return new Deferred};function Deferred(){var self=this;this.promise=promise.factory();this.onDone=[];this.onAlways=[];this.onFail=[];this.promise.then(function(arg){promise.delay(function(){array.each(self.onDone,function(i){i(arg)});array.each(self.onAlways,function(i){i(arg)});self.onAlways=[];self.onDone=[];self.onFail=[]})},function(arg){promise.delay(function(){array.each(self.onFail,function(i){i(arg)});array.each(self.onAlways,function(i){i(arg)});
self.onAlways=[];self.onDone=[];self.onFail=[]})})}Deferred.prototype.constructor=Deferred;Deferred.prototype.always=function(arg){if(typeof arg!=="function")throw new Error(label.error.invalidArguments);else if(this.promise.state>0)throw new Error(label.error.promiseResolved.replace("{{outcome}}",this.promise.value));this.onAlways.push(arg);return this};Deferred.prototype.done=function(arg){if(typeof arg!=="function")throw new Error(label.error.invalidArguments);else if(this.promise.state>0)throw new Error(label.error.promiseResolved.replace("{{outcome}}",
this.promise.value));this.onDone.push(arg);return this};Deferred.prototype.fail=function(arg){if(typeof arg!=="function")throw new Error(label.error.invalidArguments);else if(this.promise.state>0)throw new Error(label.error.promiseResolved.replace("{{outcome}}",this.promise.value));this.onFail.push(arg);return this};Deferred.prototype.isRejected=function(){return this.promise.state===promise.state.FAILED};Deferred.prototype.isResolved=function(){return this.promise.state===promise.state.SUCCESS};
Deferred.prototype.reject=function(arg){this.promise.reject.call(this.promise,arg);return this};Deferred.prototype.resolve=function(arg){this.promise.resolve.call(this.promise,arg);return this};Deferred.prototype.state=function(){return this.promise.state};Deferred.prototype.then=function(success,failure){return this.promise.then(success,failure)};var element={appendTo:function(a,b){b.appendChild(a);return b},attr:function(obj,key,value){var target,result;if(regex.svg.test(obj.namespaceURI))if(value===
undefined){result=obj.getAttributeNS(obj.namespaceURI,key);if(result===null||string.isEmpty(result))result=undefined;else result=utility.coerce(result)}else obj.setAttributeNS(obj.namespaceURI,key,value);else{if(typeof value==="string")value=string.trim(value);if(regex.checked_disabled.test(key)&&value===undefined)return utility.coerce(obj[key]);else if(regex.checked_disabled.test(key)&&value!==undefined)obj[key]=value;else if(obj.nodeName==="SELECT"&&(key==="selected"&&value===undefined))return utility.dom("#"+
obj.id+' option[selected="selected"]')[0]||utility.dom("#"+obj.id+" option")[0];else if(obj.nodeName==="SELECT"&&(key==="selected"&&value!==undefined)){target=utility.dom("#"+obj.id+' option[selected="selected"]')[0];if(target!==undefined){target.selected=false;target.removeAttribute("selected")}target=utility.dom("#"+obj.id+' option[value="'+value+'"]')[0];target.selected=true;target.setAttribute("selected","selected")}else if(value===undefined){result=obj.getAttribute(key);if(result===null||string.isEmpty(result))result=
undefined;else result=utility.coerce(result);return result}else obj.setAttribute(key,value)}return obj},clear:function(obj){if(typeof obj.reset==="function")obj.reset();else if(obj.value!==undefined)element.update(obj,{innerHTML:"",value:""});else element.update(obj,{innerHTML:""});return obj},create:function(type,args,target,pos){var svg=false,frag=false,obj,uid,result;type=type.replace(/\t|\n|\r/g,"");if(target!==undefined)svg=target.namespaceURI!==undefined&&regex.svg.test(target.namespaceURI);
else target=document.body;if(args instanceof Object&&(args.id!==undefined&&utility.dom("#"+args.id)===undefined)){uid=args.id;delete args.id}else if(!svg)uid=utility.genId(undefined,true);if(regex.html.test(type)){frag=true;obj=element.frag(type);result=obj.childNodes.length===1?obj.childNodes[0]:array.cast(obj.childNodes)}else{if(!svg&&!regex.svg.test(type))obj=document.createElement(type);else obj=document.createElementNS("http://www.w3.org/2000/svg",type);if(uid!==undefined)obj.id=uid;if(args instanceof
Object)element.update(obj,args)}if(pos===undefined||pos==="last")target.appendChild(obj);else if(pos==="first")element.prependChild(target,obj);else if(pos==="after"){pos={};pos.after=target;target=target.parentNode;target.insertBefore(obj,pos.after.nextSibling)}else if(pos.after!==undefined)target.insertBefore(obj,pos.after.nextSibling);else if(pos==="before"){pos={};pos.before=target;target=target.parentNode;target.insertBefore(obj,pos.before)}else if(pos.before!==undefined)target.insertBefore(obj,
pos.before);else target.appendChild(obj);return!frag?obj:result},css:function(obj,key,value){key=string.toCamelCase(key);if(value!==undefined){obj.style[key]=value;return obj}else return obj.style[key]},data:function(obj,key,value){if(value!==undefined){obj.setAttribute("data-"+key,regex.json_wrap.test(value)?json.encode(value):value);return obj}else return utility.coerce(obj.getAttribute("data-"+key))},destroy:function(obj){observer.remove(obj);if(obj.parentNode!==null)obj.parentNode.removeChild(obj);
return undefined},disable:function(obj){if(typeof obj.disabled==="boolean"&&!obj.disabled)obj.disabled=true;return obj},dispatch:function(obj,type,data,bubbles,cancelable){var ev=new CustomEvent(type);bubbles=bubbles!==false;cancelable=cancelable!==false;ev.initCustomEvent(type,bubbles,cancelable,data||{});obj.dispatchEvent(ev);return obj},enable:function(obj){if(typeof obj.disabled==="boolean"&&obj.disabled)obj.disabled=false;return obj},find:function(obj,arg){var result=[];utility.genId(obj,true);
array.each(string.explode(arg),function(i){result=result.concat(utility.dom("#"+obj.id+" "+i))});return result},frag:function(arg){var obj=document.createDocumentFragment();if(arg){array.each(array.cast(element.create("div",{innerHTML:arg},obj).childNodes),function(i){obj.appendChild(i)});obj.removeChild(obj.childNodes[0])}return obj},has:function(obj,arg){var result=element.find(obj,arg);return!isNaN(result.length)&&result.length>0},hasClass:function(obj,klass){return obj.classList.contains(klass)},
hidden:function(obj){return obj.style.display==="none"||typeof obj.hidden==="boolean"&&obj.hidden},html:function(obj,arg){if(arg===undefined)return obj.innerHTML;else{obj.innerHTML=arg;return obj}},is:function(obj,arg){if(regex.selector_is.test(arg)){utility.id(obj);return element.find(obj.parentNode,obj.nodeName.toLowerCase()+arg).filter(function(i){return i.id===obj.id}).length===1}else return(new RegExp(arg,"i")).test(obj.nodeName)},isAlphaNum:function(obj){return obj.nodeName==="FORM"?false:validate.test({alphanum:obj.value||
element.text(obj)}).pass},isBoolean:function(obj){return obj.nodeName==="FORM"?false:validate.test({"boolean":obj.value||element.text(obj)}).pass},isChecked:function(obj){return obj.nodeName!=="INPUT"?false:element.attr(obj,"checked")},isDate:function(obj){return obj.nodeName==="FORM"?false:string.isDate(obj.value||element.text(obj))},isDisabled:function(obj){return obj.nodeName!=="INPUT"?false:element.attr(obj,"disabled")},isDomain:function(obj){return obj.nodeName==="FORM"?false:string.isDomain(obj.value||
element.text(obj))},isEmail:function(obj){return obj.nodeName==="FORM"?false:string.isEmail(obj.value||element.text(obj))},isEmpty:function(obj){return obj.nodeName==="FORM"?false:string.isEmpty(obj.value||element.text(obj))},isIP:function(obj){return obj.nodeName==="FORM"?false:string.isIP(obj.value||element.text(obj))},isInt:function(obj){return obj.nodeName==="FORM"?false:string.isInt(obj.value||element.text(obj))},isNumber:function(obj){return obj.nodeName==="FORM"?false:string.isNumber(obj.value||
element.text(obj))},isPhone:function(obj){return obj.nodeName==="FORM"?false:string.isPhone(obj.value||element.text(obj))},isUrl:function(obj){return obj.nodeName==="FORM"?false:string.isUrl(obj.value||element.text(obj))},klass:function(obj,arg,add){add=add!==false;arg=string.explode(arg," ");if(add)array.each(arg,function(i){obj.classList.add(i)});else array.each(arg,function(i){if(i!=="*")obj.classList.remove(i);else{array.each(obj.classList,function(x){this.remove(x)});return false}});return obj},
position:function(obj){obj=obj||document.body;var left,top,right,bottom,height,width;left=top=0;width=obj.offsetWidth;height=obj.offsetHeight;if(obj.offsetParent){top=obj.offsetTop;left=obj.offsetLeft;while(obj=obj.offsetParent){left+=obj.offsetLeft;top+=obj.offsetTop}right=document.body.offsetWidth-(left+width);bottom=document.body.offsetHeight-(top+height)}else{right=width;bottom=height}return[left,top,right,bottom]},prependChild:function(obj,child){return obj.childNodes.length===0?obj.appendChild(child):
obj.insertBefore(child,obj.childNodes[0])},removeAttr:function(obj,key){var target;if(regex.svg.test(obj.namespaceURI))obj.removeAttributeNS(obj.namespaceURI,key);else if(obj.nodeName==="SELECT"&&key==="selected"){target=utility.dom("#"+obj.id+' option[selected="selected"]')[0];if(target!==undefined){target.selected=false;target.removeAttribute("selected")}}else obj.removeAttribute(key);return obj},scrollTo:function(obj,ms,offsetTop,offsetLeft){var pos=array.remove(element.position(obj),2,3);if(!isNaN(offsetTop))pos[0]+=
offsetTop;if(!isNaN(offsetLeft))pos[1]+=offsetLeft;return client.scroll(pos,ms)},serialize:function(obj,string,encode){string=string===true;encode=encode!==false;var children=[],registry={},result;children=obj.nodeName==="FORM"?obj.elements!==undefined?array.cast(obj.elements):obj.find("button, input, select, textarea"):[obj];array.each(children,function(i){if(i.nodeName==="FORM")utility.merge(registry,json.decode(element.serialize(i)));else if(registry[i.name]===undefined)registry[i.name]=element.val(i)});
if(!string)result=json.encode(registry);else{result="";utility.iterate(registry,function(v,k){encode?result+="&"+encodeURIComponent(k)+"="+encodeURIComponent(v):result+="&"+k+"="+v});result=result.replace(regex.and,"?")}return result},size:function(obj){return{height:obj.offsetHeight+number.parse(obj.style.paddingTop||0)+number.parse(obj.style.paddingBottom||0)+number.parse(obj.style.borderTop||0)+number.parse(obj.style.borderBottom||0),width:obj.offsetWidth+number.parse(obj.style.paddingLeft||0)+
number.parse(obj.style.paddingRight||0)+number.parse(obj.style.borderLeft||0)+number.parse(obj.style.borderRight||0)}},text:function(obj,arg){var key=obj.textContent!==undefined?"textContent":"innerText",payload={},set=false;if(typeof arg!=="undefined"){set=true;payload[key]=arg}return set?element.update(obj,payload):obj[key]},toggleClass:function(obj,arg){obj.classList.toggle(arg);return obj},update:function(obj,args){args=args||{};utility.iterate(args,function(v,k){if(regex.element_update.test(k))obj[k]=
v;else if(k==="class")!string.isEmpty(v)?element.klass(obj,v):element.klass(obj,"*",false);else if(k.indexOf("data-")===0)element.data(obj,k.replace("data-",""),v);else if(k==="id"){var o=observer.listeners;if(o[obj.id]!==undefined){o[k]=o[obj.id];delete o[obj.id]}}else element.attr(obj,k,v)});return obj},val:function(obj,value){var event="input",output;if(value===undefined){if(regex.radio_checkbox.test(obj.type)){if(string.isEmpty(obj.name))throw new Error(label.error.expectedProperty);array.each(utility.dom("input[name='"+
obj.name+"']"),function(i){if(i.checked){output=i.value;return false}})}else if(regex.select.test(obj.type))output=obj.options[obj.selectedIndex].value;else if(obj.value)output=obj.value;else output=element.text(obj);if(output!==undefined)output=utility.coerce(output);if(typeof output==="string")output=string.trim(output)}else{value=value.toString();if(regex.radio_checkbox.test(obj.type)){event="click";array.each(utility.dom("input[name='"+obj.name+"']"),function(i){if(i.value===value){i.checked=
true;output=i;return false}})}else if(regex.select.test(obj.type)){event="change";array.each(element.find(obj,"> *"),function(i){if(i.value===value){i.selected=true;output=i;return false}})}else obj.value!==undefined?obj.value=value:element.text(obj,value);element.dispatch(obj,event);output=obj}return output},validate:function(obj){return obj.nodeName==="FORM"?validate.test(obj):!string.isEmpty(obj.value||element.text(obj))}};var filter=function(obj,datalist,filters,debounce){debounce=debounce||250;
var ref=[datalist];if(!(obj instanceof Element)||(datalist!==undefined&&datalist.store===undefined||(typeof filters!=="string"||string.isEmpty(filters))))throw new Error(label.error.invalidArguments);return(new DataListFilter(obj,ref[0],debounce)).set(filters).init()};function DataListFilter(element,datalist,debounce){this.element=element;this.datalist=datalist;this.debounce=debounce;this.filters={}}DataListFilter.prototype.constructor=DataListFilter;DataListFilter.prototype.init=function(){observer.add(this.element,
"keyup",this.update,"filter",this);observer.add(this.element,"input",this.update,"value",this);return this};DataListFilter.prototype.set=function(fields){var obj={};array.each(string.explode(fields),function(v){obj[v]=""});this.filters=obj;return this};DataListFilter.prototype.teardown=function(){observer.remove(this.element,"keyup","filter");observer.remove(this.element,"input","value");return this};DataListFilter.prototype.update=function(){var self=this;utility.defer(function(){var val=element.val(self.element).toString();
if(!string.isEmpty(val)){utility.iterate(self.filters,function(v,k){var queries=string.explode(val);queries=queries.filter(function(i){return!string.isEmpty(i)});array.each(queries,function(i,idx){this[idx]="^"+string.escape(i).replace("\\*",".*")});this[k]=queries.join(",")});self.datalist.filter=self.filters}else self.datalist.filter=null;self.datalist.pageIndex=1;self.datalist.refresh(true,self.datalist.store.datalists.length>1)},this.debounce,this.element.id+"Debounce");return this};var grid=
function(obj,store,fields,sortable,options,filtered,debounce){var ref=[store];return(new DataGrid(obj,ref[0],fields,sortable,options,filtered)).init(debounce)};function DataGrid(obj,store,fields,sortable,options,filtered){var sortOrder;if(options.order&&!string.isEmpty(options.order))sortOrder=string.explode(options.order).map(function(i){return i.replace(regex.after_space,"")});this.element=obj;this.fields=fields;this.filter=null;this.filtered=filtered===true;this.initialized=false;this.list=null;
this.options=options||{};this.store=store;this.sortable=sortable||[];this.sortOrder=sortOrder||(sortable||[])}DataGrid.prototype.constructor=DataGrid;DataGrid.prototype.dump=function(){return this.store.dump(this.list.records,this.fields)};DataGrid.prototype.init=function(debounce){var self,ref,template,container,header,width,css,sort;if(!this.initialized){self=this;ref=[];template="";container=element.create("section",{"class":"grid"},this.element);header=element.create("ul",{"class":"header"},container);
width=100/this.fields.length+"%";css="display:inline-block;width:"+width;sort=this.options.order?string.explode(this.options.order):[];array.each(this.fields,function(i){var trimmed=i.replace(/.*\./g,""),obj=header.create("span",{innerHTML:string.capitalize(string.unCamelCase(string.unhyphenate(trimmed,true)),true),style:css,"class":trimmed,"data-field":i});if(self.sortable.contains(i)){element.klass(obj,"sortable",true);if(sort.filter(function(x){return x.indexOf(i)===0}).length>0)element.data(obj,
"sort",array.contains(sort,i+" desc")?"desc":"asc")}template+='<span class="'+i+'" data-field="'+i+'" style="'+css+'">{{'+i+"}}</span>"});if(this.sortable.length>0)observer.add(header,"click",this.sort,"sort",this);ref.push(datalist.factory(container,this.store,template,this.options));this.list=ref[0];if(this.filtered===true){ref.push(filter(element.create("input",{"class":"filter"},container,"first"),ref[0],this.fields.join(","),debounce||250));this.filter=ref[1]}this.initialized=true}return this};
DataGrid.prototype.refresh=function(){var sort=[],self=this;if(this.sortOrder.length>0){array.each(this.sortOrder,function(i){var obj=element.find(self.element,".header span[data-field='"+i+"']")[0];sort.push(string.trim(i+" "+(element.data(obj,"sort")||"")))});this.options.order=this.list.order=sort.join(", ")}this.list.where=null;utility.merge(this.list,this.options);this.list.refresh();return this};DataGrid.prototype.sort=function(e){var target=utility.target(e),field;utility.stop(e);if(element.hasClass(target,
"sortable")){field=element.data(target,"field");element.data(target,"sort",element.data(target,"sort")==="asc"?"desc":"asc");array.remove(this.sortOrder,field);this.sortOrder.splice(0,0,field);this.refresh()}return this};DataGrid.prototype.teardown=function(){if(this.filter!==null)this.filter.teardown();this.list.teardown();observer.remove(element.find(this.element,".header")[0],"click","sort");element.destroy(element.find(this.element,".grid")[0]);return this};var json={csv:function(arg,delimiter,
header){delimiter=delimiter||",";header=header!==false;var obj=json.decode(arg,true)||arg,result="",prepare;prepare=function(input){var output;if(input instanceof Array){output='"'+input.toString()+'"';if(regex.object_type.test(output))output='"'+json.csv(input,delimiter)+'"'}else if(input instanceof Object)output='"'+json.csv(input,delimiter)+'"';else if(regex.csv_quote.test(input))output='"'+input.replace(/"/g,'""')+'"';else output=input;return output};if(obj instanceof Array)if(obj[0]instanceof
Object){if(header)result=array.keys(obj[0]).join(delimiter)+"\n";result+=obj.map(function(i){return json.csv(i,delimiter,false)}).join("\n")}else result+=prepare(obj,delimiter)+"\n";else{if(header)result=array.keys(obj).join(delimiter)+"\n";result+=array.cast(obj).map(prepare).join(delimiter)+"\n"}return result.replace(/\n$/,"")},decode:function(arg,silent){try{return JSON.parse(arg)}catch(e){if(silent!==true)utility.error(e,arguments,this);return undefined}},encode:function(arg,silent){try{return JSON.stringify(arg)}catch(e){if(silent!==
true)utility.error(e,arguments,this);return undefined}}};var label={common:{back:"Back",cancel:"Cancel",clear:"Clear",close:"Close",cont:"Continue",create:"Create",customRange:"Custom Range",del:"Delete",edit:"Edit",find:"Find",from:"From",gen:"Generate",go:"Go",loading:"Loading",next:"Next",login:"Login",ran:"Random",reset:"Reset",save:"Save",search:"Search",send:"Send",submit:"Submit",to:"To",today:"Today",yesterday:"Yesterday"},day:{0:"Sunday",1:"Monday",2:"Tuesday",3:"Wednesday",4:"Thursday",
5:"Friday",6:"Saturday"},error:{databaseNotOpen:"Failed to open the Database, possibly exceeded Domain quota",databaseNotSupported:"Client does not support local database storage",databaseWarnInjection:"Possible SQL injection in database transaction, use the &#63; placeholder",databaseMoreThanOne:"More than one match found",elementNotCreated:"Could not create the Element",elementNotFound:"Could not find the Element",expectedArray:"Expected an Array",expectedArrayObject:"Expected an Array or Object",
expectedBoolean:"Expected a Boolean value",expectedNumber:"Expected a Number",expectedProperty:"Expected a property, and it was not set",expectedObject:"Expected an Object",invalidArguments:"One or more arguments is invalid",invalidDate:"Invalid Date",invalidFields:"The following required fields are invalid: ",invalidRoute:"The route could not be found",invalidStateNoHeaders:"INVALID_STATE_ERR: Headers have not been received",invalidStateNoSync:"Synchronous XMLHttpRequest requests are not supported",
invalidStateNotOpen:"INVALID_STATE_ERR: Object is not open",invalidStateNotSending:"INVALID_STATE_ERR: Object is sending",invalidStateNotUsable:"INVALID_STATE_ERR: Object is not usable",notAvailable:"Requested method is not available",notSupported:"This feature is not supported by this platform",propertyNotFound:"Could not find the requested property",promisePending:"The promise cannot be resolved while pending result",promiseResolved:"The promise has been resolved: {{outcome}}",serverError:"Server error has occurred",
serverForbidden:"Forbidden to access URI",serverInvalidMethod:"Method not allowed",serverUnauthorized:"Authorization required to access URI",readOnly:"Property is read only",upgrade:"Your browser is too old to use abaaso, please upgrade"},month:{0:"January",1:"February",2:"March",3:"April",4:"May",5:"June",6:"July",7:"August",8:"September",9:"October",10:"November",11:"December"}};var lru=function(max){return new LRU(max)};function LRU(max){this.cache={};this.max=max||1E3;this.first=null;this.last=
null;this.length=0}LRU.prototype.constructor=LRU;LRU.prototype.evict=function(){if(this.last!==null)this.remove(this.last);return this};LRU.prototype.get=function(key){var item=this.cache[key];if(item===undefined)return;this.set(key,item.value);return item.value};LRU.prototype.remove=function(key){var item=this.cache[key];if(item!==undefined){delete this.cache[key];this.length--;if(item.previous!==null)this.cache[item.previous].next=item.next;if(item.next!==null)this.cache[item.next].previous=item.previous;
if(this.first===key)this.first=item.previous;if(this.last===key)this.last=item.next}return item};LRU.prototype.set=function(key,value){var item=this.remove(key);if(item===undefined)item=new LRUItem(value);else item.value=value;item.next=null;item.previous=this.first;this.cache[key]=item;if(this.first!==null)this.cache[this.first].next=key;this.first=key;if(this.last===null)this.last=key;if(++this.length>this.max)this.evict();return this};function LRUItem(value){this.next=null;this.previous=null;this.value=
value}LRUItem.prototype.constructor=LRUItem;var math={bezier:function(){var a=array.cast(arguments),t=a.pop(),P=array.chunk(a,2),n=P.length,c,S0,Q0,Q1,Q2,C0,C1,C2,C3;if(n<2||n>4)throw new Error(label.error.invalidArguments);c=[];S0=1-t;Q0=math.sqr(S0);Q1=2*S0*t;Q2=math.sqr(t);C0=Math.pow(S0,3);C1=3*Q0*t;C2=3*S0*Q2;C3=Math.pow(t,3);if(n===2){c.push(S0*P[0][0]+t*P[1][0]);c.push(S0*P[0][1]+t*P[1][1])}else if(n===3){c.push(Q0*P[0][0]+Q1*P[1][0]+(Q2+P[2][0]));c.push(Q0*P[0][1]+Q1*P[1][1]+(Q2+P[2][1]))}else if(n===
4){c.push(C0*P[0][0]+C1*P[1][0]+C2*P[2][0]+C3*P[3][0]);c.push(C0*P[0][1]+C1*P[1][1]+C2*P[2][1]+C3*P[3][1])}return c},dist:function(a,b){return Math.sqrt(math.sqr(b[0]-a[0])+math.sqr(b[1]-a[1]))},sqr:function(n){return n*n}};var message={clear:function(state){state=state||"all";return observer.remove(global,"message","message",state)},send:function(target,arg){try{target.postMessage(arg,"*")}catch(e){utility.error(e,arguments,this)}return target},recv:function(fn,state){state=state||"all";return observer.add(global,
"message",fn,"message",global,state)}};var mouse={enabled:false,log:false,diff:{x:null,y:null},pos:{x:null,y:null},prev:{x:null,y:null},track:function(arg){var type=typeof arg;if(type==="object"){var v=document.body,x=arg.pageX?arg.pageX:v.scrollLeft+arg.clientX,y=arg.pageY?arg.pageY:v.scrollTop+arg.clientY,c=false;if(mouse.pos.x!==x)c=true;abaaso.mouse.prev.x=mouse.prev.x=number.parse(mouse.pos.x,10);abaaso.mouse.pos.x=mouse.pos.x=x;abaaso.mouse.diff.x=mouse.diff.x=mouse.pos.x-mouse.prev.x;if(mouse.pos.y!==
y)c=true;abaaso.mouse.prev.y=mouse.prev.y=number.parse(mouse.pos.y,10);abaaso.mouse.pos.y=mouse.pos.y=y;abaaso.mouse.diff.y=mouse.diff.y=mouse.pos.y-mouse.prev.y;if(c&&abaaso.mouse.log)utility.log([mouse.pos.x,mouse.pos.y,mouse.diff.x,mouse.diff.y])}else if(type==="boolean"){arg?observer.add(document,"mousemove",mouse.track,"tracking"):observer.remove(document,"mousemove","tracking");abaaso.mouse.enabled=mouse.enabled=arg}return abaaso.mouse}};var number={diff:function(num1,num2){if(isNaN(num1)||
isNaN(num2))throw new Error(label.error.expectedNumber);return Math.abs(num1-num2)},even:function(arg){return arg%2===0},format:function(arg,delimiter,every){if(isNaN(arg))throw new Error(label.error.expectedNumber);arg=arg.toString();delimiter=delimiter||",";every=every||3;var d=arg.indexOf(".")>-1?"."+arg.replace(regex.number_format_1,""):"",a=arg.replace(regex.number_format_2,"").split("").reverse(),p=Math.floor(a.length/every),i=1,n,b;for(b=0;b<p;b++){n=i===1?every:every*i+(i===2?1:i-1);a.splice(n,
0,delimiter);i++}a=a.reverse().join("");if(a.charAt(0)===delimiter)a=a.substring(1);return a+d},half:function(a,b){return b!==undefined?a/b===0.5:a/2},odd:function(arg){return!number.even(arg)},parse:function(arg,base){return base===undefined?parseFloat(arg):parseInt(arg,base)},random:function(arg){arg=arg||100;return Math.floor(Math.random()*(arg+1))},round:function(arg,direction){arg=number.parse(arg);if(direction===undefined||string.isEmpty(direction))return number.parse(arg.toFixed(0));else if(regex.down.test(direction))return~~arg;
else return Math.ceil(arg)}};var observer={elisteners:{},ignore:false,listeners:{},log:false,maxListeners:10,queue:[],silent:false,add:function(obj,events,fn,id,scope,st){var oId=observer.id(obj),instance=regex.observer_globals.test(oId)||!/\//g.test(oId)&&oId!=="abaaso"?obj:null,jsonp=/^afterjsonp$/i,add=false,reg=false;if(!oId||(!events||typeof fn!=="function"))throw new Error(label.error.invalidArguments);id=id||utility.uuid();scope=scope||obj;st=st||state.getCurrent();if(!observer.listeners[oId]){observer.listeners[oId]=
{};observer.listeners[oId].all={}}if(st!=="all"&&!observer.listeners[oId][st])observer.listeners[oId][st]={};if(instance){add=typeof instance.addEventListener==="function";reg=typeof instance.attachEvent==="object"||add}array.each(string.explode(events),function(ev){var eId=oId+"_"+ev;if(!observer.listeners[oId].all[ev])observer.listeners[oId].all[ev]=lru(observer.maxListeners);if(st!=="all"&&!observer.listeners[oId][st][ev])observer.listeners[oId][st][ev]=lru(observer.maxListeners);if(reg&&(!jsonp.test(ev)&&
!observer.elisteners[eId])){observer.elisteners[eId]=function(e){observer.fire(oId,ev,e)};instance[add?"addEventListener":"attachEvent"]((add?"":"on")+ev,observer.elisteners[eId],false)}observer.listeners[oId][st][ev].set(id,{fn:fn,scope:scope})});return obj},decorate:function(){var methods=[["fire",function(){return observer.fire.apply(observer,[this].concat(array.cast(arguments)))}],["listeners",function(e){return observer.list(this,e)}],["on",function(e,listener,id,scope,standby){return observer.add(this,
e,listener,id,scope,standby)}],["once",function(e,listener,id,scope,standby){return observer.once(this,e,listener,id,scope,standby)}],["un",function(e,id){return observer.remove(this,e,id)}]];array.each(methods,function(i){utility.property(obj,i[0],{value:i[1],configurable:true,enumerable:true,writable:true})});return obj},discard:function(arg){return arg===undefined?observer.ignore:observer.ignore=arg===true},fire:function(obj,events){var args,log,cache,item,oId;if(!observer.ignore)if(observer.silent)observer.queue.push(array.cast(arguments));
else{oId=observer.id(obj);if(observer.listeners[oId]){args=array.remove(array.cast(arguments),0,1);log=abaaso.logging;array.each(string.explode(events),function(ev){if(log)utility.log(oId+" fired "+ev);array.each(observer.states(),function(st){if(observer.listeners[oId][st]&&observer.listeners[oId][st][ev]){cache=observer.listeners[oId][st][ev];if(cache.length>0){item=cache.cache[cache.last];do if(item.value.fn.apply(item.value.scope,args)!==false&&item.next)item=cache.cache[item.next];else return false;
while(item)}}})})}}return obj},id:function(arg){var id;if(arg===global)id="window";else if(!server&&arg===document)id="document";else if(!server&&arg===document.body)id="body";else{utility.genId(arg);id=arg.id||(typeof arg.toString==="function"?arg.toString():arg)}return id},list:function(obj,ev){var oId=observer.id(obj),states=observer.states(),result={};if(!observer.listeners[oId]);else if(!ev||string.isEmpty(ev))array.each(observer.states(),function(st){if(observer.listeners[oId][st])array.each(array.keys(observer.listeners[oId][st]),
function(ev){result[st]=observer.listeners[oId][st][ev].cache})});else array.each(observer.states(),function(st){if(observer.listeners[oId][st]&&observer.listeners[oId][st][ev])result[st]=observer.listeners[oId][st][ev].cache});return result},once:function(obj,events,fn,id,scope,st){id=id||utility.uuid();scope=scope||obj;st=st||state.getCurrent();if(!obj||(!events||typeof fn!=="function"))throw new Error(label.error.invalidArguments);array.each(string.explode(events),function(ev){observer.add(obj,
ev,function(){fn.apply(scope,arguments);observer.remove(obj,ev,id,st)},id,scope,st)});return obj},pause:function(arg){if(arg===true)observer.silent=arg;else if(arg===false){observer.silent=arg;array.each(observer.queue,function(i){observer.fire.apply(observer,i)});observer.queue=[]}return observer.silent},remove:function(obj,events,id,st){var oId=observer.id(obj),add=typeof obj.addEventListener==="function",reg=typeof obj.attachEvent==="object"||add,regex=/.*_/,states,total,unhook;st=st||state.getCurrent();
unhook=function(eId,ev){if(reg)obj[add?"removeEventListener":"detachEvent"]((add?"":"on")+ev,this[eId],false);delete this[eId]};if(observer.listeners[oId])if(!events){utility.iterate(observer.elisteners,function(v,k){if(k.indexOf(oId+"_")===0)unhook.call(this,k,k.replace(regex,""))});delete observer.listeners[oId]}else{events=string.explode(events);states=array.keys(observer.listeners[oId]);total=0;array.each(states,function(s){array.each(events,function(e){if(observer.listeners[oId][s][e])total+=
observer.listeners[oId][s][e].length})});array.each(events,function(ev){if(observer.listeners[oId][st][ev])if(id){observer.listeners[oId][st][ev].remove(id);total--;if(total===0){array.each(states,function(s){delete observer.listeners[oId][s][ev]});unhook.call(observer.elisteners,oId+"_"+ev,ev)}}else{array.each(states,function(s){delete observer.listeners[oId][s][ev]});unhook.call(observer.elisteners,oId+"_"+ev,ev)}})}return obj},states:function(){return["all",state.getCurrent()]}};var promise={delay:function(){if(typeof setImmediate!==
"undefined")return setImmediate;else if(typeof process!=="undefined")return process.nextTick;else return function(arg){setTimeout(arg,0)}}(),factory:function(){return new Promise},pipe:function(parent,child){parent.then(function(arg){child.resolve(arg)},function(e){child.reject(e)})},state:{PENDING:0,FAILURE:1,SUCCESS:2}};function Promise(){this.deferred=false;this.handlers=[];this.state=promise.state.PENDING;this.value=null}Promise.prototype.constructor=Promise;Promise.prototype.process=function(){var result,
success,value;this.deferred=false;if(this.state===promise.state.PENDING)return;value=this.value;success=this.state===promise.state.SUCCESS;array.each(this.handlers.slice(),function(i){var callback=i[success?"success":"failure"],child=i.promise;if(!callback||typeof callback!=="function"){if(value&&typeof value.then==="function")promise.pipe(value,child);else if(success)child.resolve(value);else child.reject(value);return}try{result=callback(value)}catch(e){child.reject(e);return}if(result&&typeof result.then===
"function")promise.pipe(result,promise);else child.resolve(result)});return this};Promise.prototype.reject=function(arg){var self=this;if(this.state>promise.state.PENDING)return;this.value=arg;this.state=promise.state.FAILURE;if(!this.deferred){promise.delay(function(){self.process()});this.deferred=true}return this};Promise.prototype.resolve=function(arg){var self=this;if(this.state>promise.state.PENDING)return;this.value=arg;this.state=promise.state.SUCCESS;if(!this.deferred){promise.delay(function(){self.process()});
this.deferred=true}return this};Promise.prototype.then=function(success,failure){var self=this,child=new Promise;this.handlers.push({success:success,failure:failure,promise:child});if(this.state>promise.state.PENDING&&!this.deferred){promise.delay(function(){self.process()});this.deferred=true}return child};var prototypes={array:{add:function(arg){return array.add(this,arg)},addClass:function(arg){return array.each(this,function(i){element.klass(i,arg)})},after:function(type,args){var result=[];array.each(this,
function(i){result.push(element.create(type,args,i,"after"))});return result},append:function(type,args){var result=[];array.each(this,function(i){result.push(element.create(type,args,i,"last"))});return result},attr:function(key,value){var result=[];array.each(this,function(i){result.push(element.attr(i,key,value))});return result},before:function(type,args){var result=[];array.each(this,function(i){result.push(element.create(type,args,i,"before"))});return result},binIndex:function(arg){return array.binIndex(this,
arg)},chunk:function(size){return array.chunk(this,size)},clear:function(){return!server&&this[0]instanceof Element?array.each(this,function(i){element.clear(i)}):array.clear(this)},clone:function(){return utility.clone(this)},collect:function(arg){return array.collect(this,arg)},compact:function(){return array.compact(this)},contains:function(arg){return array.contains(this,arg)},count:function(arg){return array.count(this,arg)},create:function(type,args,position){var result=[];array.each(this,function(i){result.push(element.create(type,
args,i,position))});return result},css:function(key,value){return array.each(this,function(i){element.css(i,key,value)})},data:function(key,value){var result=[];array.each(this,function(i){result.push(element.data(i,key,value))});return result},diff:function(arg){return array.diff(this,arg)},disable:function(){return array.each(this,function(i){element.disable(i)})},dispatch:function(event,data,bubbles,cancelable){return array.each(this,function(i){element.dispatch(i,event,data,bubbles,cancelable)})},
destroy:function(){array.each(this,function(i){element.destroy(i)});return[]},each:function(arg,async,size){return array.each(this,arg,async,size)},empty:function(){return array.empty(this)},enable:function(){return array.each(this,function(i){element.enable(i)})},equal:function(arg){return array.equal(this,arg)},fib:function(arg){return array.fib(arg)},fill:function(arg,start,offset){return array.fill(this,arg,start,offset)},find:function(arg){var result=[];array.each(this,function(i){element.find(i,
arg).each(function(r){result.add(r)})});return result},fire:function(){var args=arguments;return array.each(this,function(i){observer.fire.apply(observer,[i].concat(array.cast(args)))})},first:function(){return array.first(this)},flat:function(){return array.flat(this)},genId:function(){return array.each(this,function(i){utility.genId(i)})},get:function(uri,headers){var result=[];array.each(this,function(i,idx){i.get(uri,headers,function(arg){result[idx]=arg},function(e){result[idx]=e})});return result},
has:function(arg){var result=[];array.each(this,function(i){result.push(element.has(i,arg))});return result},hasClass:function(arg){var result=[];array.each(this,function(i){result.push(element.hasClass(i,arg))});return result},html:function(arg){var result;if(arg!==undefined)return array.each(this,function(i){element.html(i,arg)});else{result=[];array.each(this,function(i){result.push(element.html(i))});return result}},index:function(arg){return array.index(this,arg)},indexed:function(){return array.indexed(this)},
intersect:function(arg){return array.intersect(this,arg)},is:function(arg){var result=[];array.each(this,function(i){result.push(element.is(i,arg))});return result},isAlphaNum:function(){var result=[];array.each(this,function(i){result.push(i.isAlphaNum())});return result},isBoolean:function(){var result=[];array.each(this,function(i){result.push(i.isBoolean())});return result},isChecked:function(){var result=[];array.each(this,function(i){result.push(i.isChecked())});return result},isDate:function(){var result=
[];array.each(this,function(i){result.push(i.isDate())});return result},isDisabled:function(){var result=[];array.each(this,function(i){result.push(element.isDisabled(i))});return result},isDomain:function(){var result=[];array.each(this,function(i){result.push(i.isDomain())});return result},isEmail:function(){var result=[];array.each(this,function(i){result.push(i.isEmail())});return result},isEmpty:function(){var result=[];array.each(this,function(i){result.push(i.isEmpty())});return result},isHidden:function(){var result=
[];array.each(this,function(i){result.push(element.isHidden(i))});return result},isIP:function(){var result=[];array.each(this,function(i){result.push(i.isIP())});return result},isInt:function(){var result=[];array.each(this,function(i){result.push(i.isInt())});return result},isNumber:function(){var result=[];array.each(this,function(i){result.push(i.isNumber())});return result},isPhone:function(){var result=[];array.each(this,function(i){result.push(i.isPhone())});return result},isUrl:function(){var result=
[];array.each(this,function(i){result.push(i.isUrl())});return result},keepIf:function(fn){return array.keepIf(this,fn)},keySort:function(query,sub){return array.keySort(this,query,sub)},keys:function(){return array.keys(this)},last:function(arg){return array.last(this,arg)},limit:function(start,offset){return array.limit(this,start,offset)},listeners:function(event){var result=[];array.each(this,function(i){array.merge(result,observer.listeners(i,event))});return result},loading:function(){return array.each(this,
function(i){utility.loading(i)})},max:function(){return array.max(this)},mean:function(){return array.mean(this)},median:function(){return array.median(this)},merge:function(arg){return array.merge(this,arg)},min:function(){return array.min(this)},mingle:function(arg){return array.mingle(this,arg)},mode:function(){return array.mode(this)},on:function(event,listener,id,scope,state){return array.each(this,function(i){observer.add(i,event,listener,id,scope||i,state)})},once:function(event,listener,id,
scope,state){return array.each(this,function(i){observer.once(i,event,listener,id,scope||i,state)})},percents:function(precision,total){return array.percents(this,precision,total)},position:function(){var result=[];array.each(this,function(i){result.push(element.position(i))});return result},prepend:function(type,args){var result=[];array.each(this,function(i){result.push(element.create(type,args,i,"first"))});return result},range:function(){return array.range(this)},rassoc:function(arg){return array.rassoc(this,
arg)},reject:function(fn){return array.reject(this,fn)},remove:function(start,end){return array.remove(this,start,end)},removeIf:function(fn){return array.removeIf(this,fn)},removeWhile:function(fn){return array.removeWhile(this,fn)},removeAttr:function(key){array.each(this,function(i){element.removeAttr(i,key)});return this},removeClass:function(arg){return array.each(this,function(i){element.klass(i,arg,false)})},replace:function(arg){return array.replace(this,arg)},rest:function(arg){return array.rest(this,
arg)},rindex:function(arg){return array.rindex(this,arg)},rotate:function(arg){return array.rotate(this,arg)},serialize:function(string,encode){return element.serialize(this,string,encode)},series:function(start,end,offset){return array.series(start,end,offset)},size:function(){var result=[];array.each(this,function(i){result.push(element.size(i))});return result},sorted:function(){return array.sorted(this)},split:function(size){return array.split(this,size)},sum:function(){return array.sum(this)},
take:function(arg){return array.take(this,arg)},text:function(arg){return array.each(this,function(node){if(typeof node!=="object")node=utility.object(node);if(typeof node.text==="function")node.text(arg)})},tpl:function(arg){return array.each(this,function(i){utility.tpl(arg,i)})},toggleClass:function(arg){return array.each(this,function(i){element.toggleClass(i,arg)})},total:function(){return array.total(this)},toObject:function(){return array.toObject(this)},un:function(event,id,state){return array.each(this,
function(i){observer.remove(i,event,id,state)})},unique:function(){return array.unique(this)},update:function(arg){return array.each(this,function(i){element.update(i,arg)})},val:function(arg){var a=[],type=null,same=true;array.each(this,function(i){if(type!==null)same=type===i.type;type=i.type;if(typeof i.val==="function")a.push(element.val(i,arg))});return same?a[0]:a},validate:function(){var result=[];array.each(this,function(i){result.push(element.validate(i))});return result},zip:function(){return array.zip(this,
arguments)}},element:{addClass:function(arg){return element.klass(this,arg,true)},after:function(type,args){return element.create(type,args,this,"after")},append:function(type,args){return element.create(type,args,this,"last")},attr:function(key,value){return element.attr(this,key,value)},before:function(type,args){return element.create(type,args,this,"before")},clear:function(){return element.clear(this)},create:function(type,args,position){return element.create(type,args,this,position)},css:function(key,
value){return element.css(this,key,value)},data:function(key,value){return element.data(this,key,value)},destroy:function(){return element.destroy(this)},disable:function(){return element.disable(this)},dispatch:function(event,data,bubbles,cancelable){return element.dispatch(this,event,data,bubbles,cancelable)},enable:function(){return element.enable(this)},find:function(arg){return element.find(this,arg)},fire:function(){return observer.fire.apply(observer,[this].concat(array.cast(arguments)))},
genId:function(){return utility.genId(this)},get:function(uri,success,failure,headers,timeout){var self=this,defer=deferred();defer.then(function(arg){element.html(self,arg);observer.fire(self,"afterGet");if(typeof success==="function")success.call(self,arg)},function(e){element.html(self,e||label.error.serverError);observer.fire(self,"failedGet");if(typeof failure==="function")failure.call(self,e);throw e;});observer.fire(this,"beforeGet");uri.get(function(arg){defer.resolve(arg)},function(e){defer.reject(e)},
headers,timeout);return defer},has:function(arg){return element.has(this,arg)},hasClass:function(arg){return element.hasClass(this,arg)},html:function(arg){return element.html(this,arg)},is:function(arg){return element.is(this,arg)},isAlphaNum:function(){return element.isAlphaNum(this)},isBoolean:function(){return element.isBoolean(this)},isChecked:function(){return element.isChecked(this)},isDate:function(){return element.isDate(this)},isDisabled:function(){return element.isDisabled(this)},isDomain:function(){return element.isDomain(this)},
isEmail:function(){return element.isEmail(this)},isEmpty:function(){return element.isEmpty(this)},isHidden:function(){return element.hidden(this)},isIP:function(){return element.isIP(this)},isInt:function(){return element.isInt(this)},isNumber:function(){return element.isNumber(this)},isPhone:function(){return element.isPhone(this)},isUrl:function(){return element.isUrl(this)},jsonp:function(uri,property,callback){var target=this,arg=property;return client.jsonp(uri,function(response){var self=target,
node=response,prop=arg,result;try{if(prop!==undefined){prop=prop.replace(/\]|'|"/g,"").replace(/\./g,"[").split("[");prop.each(function(i){node=node[!!isNaN(i)?i:number.parse(i,10)];if(node===undefined)throw new Error(label.error.propertyNotFound);});result=node}else result=response}catch(e){result=label.error.serverError;utility.error(e,arguments,this)}element.html(self,result)},function(e){element.html(target,label.error.serverError);throw e;},callback)},listeners:function(event){return observer.list(this,
event)},loading:function(){return utility.loading(this)},on:function(event,listener,id,scope,state){return observer.add(this,event,listener,id,scope||this,state)},once:function(event,listener,id,scope,state){return observer.once(this,event,listener,id,scope||this,state)},prepend:function(type,args){return element.create(type,args,this,"first")},prependChild:function(child){return element.prependChild(this,child)},position:function(){return element.position(this)},removeAttr:function(key){return element.removeAttr(this,
key)},removeClass:function(arg){return element.klass(this,arg,false)},scrollTo:function(ms,offsetTop,offsetLeft){return element.scrollTo(this,ms,offsetTop,offsetLeft)},serialize:function(string,encode){return element.serialize(this,string,encode)},size:function(){return element.size(this)},text:function(arg){return element.text(this,arg)},toggleClass:function(arg){return element.toggleClass(this,arg)},tpl:function(arg){return utility.tpl(arg,this)},un:function(event,id,state){return observer.remove(this,
event,id,state)},update:function(args){return element.update(this,args)},val:function(arg){return element.val(this,arg)},validate:function(){return element.validate(this)}},"function":{reflect:function(){return utility.reflect(this)},debounce:function(ms){return utility.debounce(this,ms)}},math:{bezier:math.bezier,dist:math.dist,sqr:math.sqr},number:{diff:function(arg){return number.diff(this,arg)},fire:function(){return observer.fire.apply(observer,[this.toString()].concat(array.cast(arguments)))},
format:function(delimiter,every){return number.format(this,delimiter,every)},half:function(arg){return number.half(this,arg)},isEven:function(){return number.even(this)},isOdd:function(){return number.odd(this)},listeners:function(event){return observer.list(this.toString(),event)},on:function(event,listener,id,scope,state){observer.add(this.toString(),event,listener,id,scope||this,state);return this},once:function(event,listener,id,scope,state){observer.once(this.toString(),event,listener,id,scope||
this,state);return this},random:function(){return number.random(this)},round:function(){return number.round(this)},roundDown:function(){return number.round(this,"down")},roundUp:function(){return number.round(this,"up")},un:function(event,id,state){observer.remove(this.toString(),event,id,state);return this}},string:{allows:function(arg){return client.allows(this,arg)},capitalize:function(arg){return string.capitalize(this,arg)},del:function(success,failure,headers){return client.request(this,"DELETE",
success,failure,null,headers)},escape:function(){return string.escape(this)},expire:function(silent){return cache.expire(this,silent)},explode:function(arg){return string.explode(this,arg)},fire:function(){return observer.fire.apply(observer,[this].concat(array.cast(arguments)))},get:function(success,failure,headers){return client.request(this,"GET",success,failure,null,headers)},headers:function(success,failure){return client.request(this,"HEAD",success,failure)},hyphenate:function(camel){return string.hyphenate(this,
camel)},isAlphaNum:function(){return string.isAlphaNum(this)},isBoolean:function(){return string.isBoolean(this)},isDate:function(){return string.isDate(this)},isDomain:function(){return string.isDomain(this)},isEmail:function(){return string.isEmail(this)},isEmpty:function(){return string.isEmpty(this)},isIP:function(){return string.isIP(this)},isInt:function(){return string.isInt(this)},isNumber:function(){return string.isNumber(this)},isPhone:function(){return string.isPhone(this)},isUrl:function(){return string.isUrl(this)},
jsonp:function(success,failure,callback){return client.jsonp(this,success,failure,callback)},listeners:function(event){return observer.list(this,event)},patch:function(success,failure,args,headers){return client.request(this,"PATCH",success,failure,args,headers)},post:function(success,failure,args,headers){return client.request(this,"POST",success,failure,args,headers)},put:function(success,failure,args,headers){return client.request(this,"PUT",success,failure,args,headers)},on:function(event,listener,
id,scope,state){return observer.add(this,event,listener,id,scope,state)},once:function(event,listener,id,scope,state){return observer.once(this,event,listener,id,scope,state)},options:function(success,failure){return client.request(this,"OPTIONS",success,failure)},permissions:function(){return client.permissions(this)},singular:function(){return string.singular(this)},toCamelCase:function(){return string.toCamelCase(this)},toNumber:function(base){return number.parse(this,base)},trim:function(){return string.trim(this)},
un:function(event,id,state){return observer.remove(this,event,id,state)},unCamelCase:function(){return string.unCamelCase(this)},uncapitalize:function(){return string.uncapitalize(this)},unhyphenate:function(arg){return string.unhyphenate(this,arg)}}};var state=function(){var prop={current:"active",previous:null,header:null},getCurrent,setCurrent,getHeader,setHeader,getPrevious,setPrevious;getCurrent=function(){return prop.current};setCurrent=function(arg){if(arg===null||(typeof arg!=="string"||(prop[0]===
arg||string.isEmpty(arg))))throw new Error(label.error.invalidArguments);prop.previous=prop.current;prop.current=arg;observer.fire("abaaso","state",arg);return arg};getHeader=function(){return prop.header};setHeader=function(arg){if(arg!==null&&(typeof arg!=="string"||(prop.header===arg||string.isEmpty(arg))))throw new Error(label.error.invalidArguments);prop.header=arg;return arg};getPrevious=function(){return prop.previous};setPrevious=function(){throw new Error(label.error.readOnly);};return{getCurrent:getCurrent,
setCurrent:setCurrent,getHeader:getHeader,setHeader:setHeader,getPrevious:getPrevious,setPrevious:setPrevious}}();var string={capitalize:function(obj,all){all=all===true;var result;if(all)result=string.explode(obj," ").map(function(i){return i.charAt(0).toUpperCase()+i.slice(1)}).join(" ");else result=obj.charAt(0).toUpperCase()+obj.slice(1);return result},escape:function(obj){return obj.replace(/[\-\[\]{}()*+?.,\\\^\$|#\s]/g,"\\$&")},explode:function(obj,arg){arg=arg||",";return string.trim(obj).split(new RegExp("\\s*"+
arg+"\\s*"))},fromObject:function(obj,name){var result=(name?name+" = {":"{")+"\n";utility.iterate(obj,function(v,k){result+='"'+k+'":'+v.toString()+",\n"});result=result.replace(/\[object Object\]/g,"{}").replace(/,\n$/,"\n")+"}";return result},hyphenate:function(obj,camel){var result=string.trim(obj).replace(/\s+/g,"-");if(camel===true)result=result.replace(/([A-Z])/g,"-$1").toLowerCase();return result},isAlphaNum:function(obj){return validate.test({alphanum:obj}).pass},isBoolean:function(obj){return validate.test({"boolean":obj}).pass},
isDate:function(obj){return validate.test({date:obj}).pass},isDomain:function(obj){return validate.test({domain:obj}).pass},isEmail:function(obj){return validate.test({email:obj}).pass},isEmpty:function(obj){return string.trim(obj)===""},isIP:function(obj){return validate.test({ip:obj}).pass},isInt:function(obj){return validate.test({integer:obj}).pass},isNumber:function(obj){return validate.test({number:obj}).pass},isPhone:function(obj){return validate.test({phone:obj}).pass},isUrl:function(obj){return validate.test({url:obj}).pass},
singular:function(obj){return regex.plural.test(obj)?obj.slice(0,-1):obj},toCamelCase:function(obj){var s=string.trim(obj).replace(/\.|_|-|\@|\[|\]|\(|\)|\#|\$|\%|\^|\&|\*|\s+/g," ").toLowerCase().split(regex.space_hyphen),r=[];array.each(s,function(i,idx){r.push(idx===0?i:string.capitalize(i))});return r.join("")},toFunction:function(obj){var args=string.trim(obj.replace(/^.*\(/,"").replace(/[\t|\r|\n|\"|\']+/g,"").replace(/\).*/,"")),body=string.trim(obj.replace(/^.*\{/,"").replace(/\}$/,""));return Function.apply(Function,
string.explode(args).concat([body]))},trim:function(obj){return obj.replace(/^(\s+|\t+)|(\s+|\t+)$/g,"")},unCamelCase:function(obj){return string.trim(obj.replace(/([A-Z])/g," $1").toLowerCase())},uncapitalize:function(obj){obj=string.trim(obj);return obj.charAt(0).toLowerCase()+obj.slice(1)},unhyphenate:function(obj,caps){if(caps!==true)return string.explode(obj,"-").join(" ");else return string.explode(obj,"-").map(function(i){return string.capitalize(i)}).join(" ")}};var utility={timer:{},repeating:{},
$:function(arg){var result;if(!arg);else if(arg.nodeName)result=[arg];else if(regex.html.test(arg))result=[element.create(arg)];else{arg=string.trim(arg);if(arg.indexOf(",")===-1){result=utility.dom(arg);if(result){if(isNaN(result.length))result=[result]}else result=[]}else{result=[];array.each(string.explode(arg),function(query){var obj=utility.dom(query);if(obj instanceof Array)result=result.concat(obj);else if(obj)result.push(obj)})}}return result},alias:function(obj,origin){var o=obj,s=origin;
utility.iterate(s,function(v,k){var getter,setter;if(!(v instanceof RegExp)&&typeof v==="function")o[k]=v.bind(o[k]);else if(!(v instanceof RegExp)&&(!(v instanceof Array)&&v instanceof Object)){if(o[k]===undefined)o[k]={};utility.alias(o[k],s[k])}else{getter=function(){return s[k]};setter=function(arg){s[k]=arg};utility.property(o,k,{enumerable:true,get:getter,set:setter,value:s[k]})}});return obj},clearTimers:function(id){if(id===undefined||string.isEmpty(id))throw new Error(label.error.invalidArguments);
if(utility.timer[id]!==undefined){clearTimeout(utility.timer[id]);delete utility.timer[id]}if(utility.repeating[id]!==undefined){clearTimeout(utility.repeating[id]);delete utility.repeating[id]}},clone:function(obj,shallow){var clone;if(shallow===true)return json.decode(json.encode(obj));else if(!obj||(regex.primitive.test(typeof obj)||obj instanceof RegExp))return obj;else if(obj instanceof Array)return obj.slice();else if(!server&&(!client.ie&&obj instanceof Document))return xml.decode(xml.encode(obj));
else if(typeof obj.__proto__!=="undefined")return utility.extend(obj.__proto__,obj);else if(obj instanceof Object){clone=json.encode(obj,true);if(clone!==undefined){clone=json.decode(clone);utility.iterate(obj,function(v,k){if(typeof v==="function")clone[k]=v})}else clone=obj;return clone}else return obj},coerce:function(value){var tmp;if(value===null||value===undefined)return undefined;else if(value==="true")return true;else if(value==="false")return false;else if(value==="null")return null;else if(value===
"undefined")return undefined;else if(value==="")return value;else if(!isNaN(tmp=Number(value)))return tmp;else if(regex.json_wrap.test(value))return json.decode(value,true)||value;else return value},compile:function(reg,pattern,modifiers){reg.compile(pattern,modifiers);return true},css:function(content,media){var ss,css;ss=element.create("style",{type:"text/css",media:media||"print, screen"},utility.dom("head")[0]);if(ss.styleSheet)ss.styleSheet.cssText=content;else{css=document.createTextNode(content);
ss.appendChild(css)}return ss},debounce:function(fn,ms,scope){ms=ms||1E3;scope=scope||global;return function debounced(){setTimeout(function(){fn.apply(scope,arguments)},ms)}},define:function(args,value,obj){args=args.split(".");var p=obj,nth=args.length;if(obj===undefined)obj=this;if(value===undefined)value=null;array.each(args,function(i,idx){var num=idx+1<nth&&!isNaN(number.parse(args[idx+1],10)),val=value;if(!isNaN(number.parse(i,10)))i=number.parse(i,10);if(p[i]===undefined)p[i]=num?[]:{};else if(p[i]instanceof
Object&&num)p[i]=array.cast(p[i]);else if(p[i]instanceof Object);else if(p[i]instanceof Array&&!num)p[i]=array.toObject(p[i]);else p[i]={};idx+1===nth?p[i]=val:p=p[i]});return obj},defer:function(fn,ms,id,repeat){var op;ms=ms||0;id=id||utility.uuid(true);repeat=repeat===true;op=function(){utility.clearTimers(id);fn()};utility.clearTimers(id);utility[repeat?"repeating":"timer"][id]=setTimeout(op,ms);return id},dom:function(arg){var result;if(!regex.selector_complex.test(arg))if(regex.hash.test(arg))result=
document.getElementById(arg.replace(regex.hash,""))||undefined;else if(regex.klass.test(arg))result=array.cast(document.getElementsByClassName(arg.replace(regex.klass,"")));else if(regex.word.test(arg))result=array.cast(document.getElementsByTagName(arg));else result=array.cast(document.querySelectorAll(arg));else result=array.cast(document.querySelectorAll(arg));return result},domId:function(arg){return"a"+arg.replace(/-/g,"").slice(1)},error:function(e,args,scope,warning){warning=warning===true;
var o={"arguments":args!==undefined?array.cast(args):[],message:e.message||e,number:e.number!==undefined?e.number&65535:undefined,scope:scope,stack:e.stack||undefined,timestamp:(new Date).toUTCString(),type:e.type||"TypeError"};utility.log(o.stack||o.message,!warning?"error":"warn");utility.error.log.push(o);observer.fire("abaaso","error",o);return undefined},extend:function(obj,arg){var o;if(obj===undefined)throw new Error(label.error.invalidArguments);o=Object.create(obj);if(arg instanceof Object)utility.merge(o,
arg);return o},fib:function(i,r){if(r===true)return i>1?utility.fib(i-1,r)+utility.fib(i-2,r):i;else return array.last(array.fib(i))},genId:function(obj,dom){dom=dom===true;var id;if(obj!==undefined&&(obj.id!==undefined&&obj.id!==""||(obj instanceof Array||(obj instanceof String||typeof obj==="string"))))return obj;if(dom){do id=utility.domId(utility.uuid(true));while(utility.dom("#"+id)!==undefined)}else id=utility.domId(utility.uuid(true));if(typeof obj==="object"){obj.id=id;return obj}else return id},
hash:function(arg){if(arg)document.location.hash=arg;return document.location.hash},hex:function(color){var digits,red,green,blue,result,i,nth;if(color.charAt(0)==="#")result=color;else{digits=string.explode(color.replace(/.*\(|\)/g,""));red=number.parse(digits[0]||0);green=number.parse(digits[1]||0);blue=number.parse(digits[2]||0);result=(blue|green<<8|red<<16).toString(16);if(result.length<6){nth=number.diff(result.length,6);i=-1;while(++i<nth)result="0"+result}result="#"+result}return result},
iterate:function(obj,fn){if(typeof fn!=="function")throw new Error(label.error.invalidArguments);array.each(Object.keys(obj),function(i){return fn.call(obj,obj[i],i)});return obj},loading:function(obj){var l=abaaso.loading;if(l.url===null||obj===undefined)throw new Error(label.error.invalidArguments);if(l.image===undefined){l.image=new Image;l.image.src=l.url}element.clear(obj);element.create("img",{alt:label.common.loading,src:l.image.src},element.create("div",{"class":"loading"},obj));return obj},
log:function(arg,target){var ts,msg;if(typeof console!=="undefined"){ts=typeof arg!=="object";msg=ts?"["+(new Date).toLocaleTimeString()+"] "+arg:arg;console[target||"log"](msg)}},merge:function(obj,arg){utility.iterate(arg,function(v,k){if(obj[k]instanceof Array&&v instanceof Array)array.merge(obj[k],v);else if(obj[k]instanceof Object&&v instanceof Object)utility.iterate(v,function(x,y){obj[k][y]=utility.clone(x)});else obj[k]=utility.clone(v)});return obj},object:function(obj){return typeof obj===
"object"?obj:obj.charAt&&obj.charAt(0)==="#"?utility.dom(obj):obj},parse:function(uri){var obj={},parsed={};if(uri===undefined)uri=!server?location.href:"";if(!server){obj=document.createElement("a");obj.href=uri}else obj=url.parse(uri);if(server)utility.iterate(obj,function(v,k){if(v===null)obj[k]=undefined});parsed={auth:server?null:regex.auth.exec(uri),protocol:obj.protocol||"http:",hostname:obj.hostname||"localhost",port:obj.port?number.parse(obj.port,10):"",pathname:obj.pathname,search:obj.search||
"",hash:obj.hash||"",host:obj.host||"localhost"};if(client.ie){if(parsed.protocol===":")parsed.protocol=location.protocol;if(string.isEmpty(parsed.hostname))parsed.hostname=location.hostname;if(string.isEmpty(parsed.host))parsed.host=location.host;if(parsed.pathname.charAt(0)!=="/")parsed.pathname="/"+parsed.pathname}parsed.auth=obj.auth||(parsed.auth===null?"":parsed.auth[1]);parsed.href=obj.href||parsed.protocol+"//"+(string.isEmpty(parsed.auth)?"":parsed.auth+"@")+parsed.host+parsed.pathname+parsed.search+
parsed.hash;parsed.path=obj.path||parsed.pathname+parsed.search;parsed.query=utility.queryString(null,parsed.search);return parsed},prevent:function(e){if(typeof e.preventDefault==="function")e.preventDefault();if(typeof e.stopPropagation==="function")e.stopPropagation();return e},property:function(obj,prop,descriptor){if(!(descriptor instanceof Object))throw new Error(label.error.invalidArguments);if(descriptor.value!==undefined&&descriptor.get!==undefined)delete descriptor.value;Object.defineProperty(obj,
prop,descriptor);return obj},proto:function(obj,type){var target=obj.prototype||obj;utility.iterate(prototypes[type],function(v,k){if(!target[k])utility.property(target,k,{value:v,configurable:true,writable:true})});return obj},queryString:function(arg,qstring){var obj={},result=qstring!==undefined?qstring.indexOf("?")>-1?qstring.replace(/.*\?/,""):null:server||string.isEmpty(location.search)?null:location.search.replace("?",""),item;if(result!==null&&!string.isEmpty(result)){result=result.split("&");
array.each(result,function(prop){item=prop.split("=");if(string.isEmpty(item[0]))return;if(item[1]===undefined||string.isEmpty(item[1]))item[1]="";else if(string.isNumber(item[1]))item[1]=Number(item[1]);else if(string.isBoolean(item[1]))item[1]=item[1]==="true";if(obj[item[0]]===undefined)obj[item[0]]=item[1];else if(!(obj[item[0]]instanceof Array)){obj[item[0]]=[obj[item[0]]];obj[item[0]].push(item[1])}else obj[item[0]].push(item[1])})}if(arg!==null&&arg!==undefined)obj=obj[arg];return obj},reflect:function(arg){if(arg===
undefined)arg=this||utility.$;arg=arg.toString().match(regex.reflect)[1];return string.explode(arg)},repeat:function(fn,ms,id,now){ms=ms||10;id=id||utility.uuid(true);now=now!==false;if(now&&fn()===false)return;utility.defer(function(){var recursive=function(fn,ms,id){var recursive=this;if(fn()!==false)utility.repeating[id]=setTimeout(function(){recursive.call(recursive,fn,ms,id)},ms);else delete utility.repeating[id]};recursive.call(recursive,fn,ms,id)},ms,id,true);return id},stop:function(e){if(e.cancelBubble!==
undefined)e.cancelBubble=true;utility.prevent(e);e.returnValue=false;return e},sugar:function(){utility.proto(Array,"array");if(typeof Element!=="undefined")utility.proto(Element,"element");utility.proto(Function,"function");utility.proto(Math,"math");utility.proto(Number,"number");utility.proto(String,"string")},target:function(e){var obj=new Abaaso;obj.push(e.target||e.srcElement);return obj},tpl:function(arg,target){var frag;if(typeof arg!=="object"||!regex.object_undefined.test(typeof target)&&
(target=target.charAt(0)==="#"?utility.dom(target):utility.dom(target)[0])===undefined)throw new Error(label.error.invalidArguments);if(target===undefined)target=utility.dom("body")[0];frag=document.createDocumentFragment();if(arg instanceof Array)array.each(arg,function(i){element.html(element.create(array.cast(i,true)[0],frag),array.cast(i)[0])});else utility.iterate(arg,function(v,k){if(typeof v==="string")element.html(element.create(k,undefined,frag),v);else if(v instanceof Array||v instanceof
Object)utility.tpl(v,element.create(k,undefined,frag))});target.appendChild(frag);return array.last(target.childNodes)},uuid:function(safe){var s=function(){return((1+Math.random())*65536|0).toString(16).substring(1)},r=[8,9,"a","b"],o;o=s()+s()+"-"+s()+"-4"+s().substr(0,3)+"-"+r[Math.floor(Math.random()*4)]+s().substr(0,3)+"-"+s()+s()+s();if(safe===true)o=o.replace(/-/g,"");return o},walk:function(obj,arg){array.each(arg.replace(/\]$/,"").replace(/\]/g,".").replace(/\.\./g,".").split(/\.|\[/),function(i){obj=
obj[i]});return obj},when:function(){var i=0,defer=deferred(),args=array.cast(arguments),nth;if(args[0]instanceof Array)args=args[0];nth=args.length;if(nth===0)defer.resolve(null);else array.each(args,function(p){p.then(function(){if(++i===nth&&!defer.isResolved())if(args.length>1)defer.resolve(args.map(function(obj){return obj.value||obj.promise.value}));else defer.resolve(args[0].value||args[0].promise.value)},function(){if(!defer.isResolved())if(args.length>1)defer.reject(args.map(function(obj){return obj.value||
obj.promise.value}));else defer.reject(args[0].value||args[0].promise.value)})});return defer}};var validate={test:function(args){var exception=false,invalid=[],value=null,c=[],p;if(args.nodeName!==undefined&&args.nodeName==="FORM"){if(string.isEmpty(args.id))utility.genId(args);c=utility.dom("#"+args.id+" input, #"+args.id+" select");array.each(c,function(i){var z={},p,v,r;p=regex[i.nodeName.toLowerCase()]?regex[i.nodeName.toLowerCase()]:!string.isEmpty(i.id)&&regex[i.id.toLowerCase()]?regex[i.id.toLowerCase()]:
"notEmpty";v=element.val(i);if(v===null)v="";z[p]=v;r=validate.test(z);if(!r.pass){invalid.push({element:i,test:p,value:v});exception=true}})}else utility.iterate(args,function(v,k){if(v===undefined||v===null){invalid.push({test:k,value:v});exception=true;return}value=v.toString().charAt(0)==="#"?utility.dom(v)!==undefined?element.val(utility.dom(v)):"":v;if(k==="date"){if(isNaN((new Date(value)).getYear())){invalid.push({test:k,value:value});exception=true}}else if(k==="domain"){if(!regex.domain.test(value.replace(regex.scheme,
""))){invalid.push({test:k,value:value});exception=true}}else if(k==="domainip"){if(!regex.domain.test(value.replace(regex.scheme,""))||!regex.ip.test(value)){invalid.push({test:k,value:value});exception=true}}else{p=regex[k]||k;if(!p.test(value)){invalid.push({test:k,value:value});exception=true}}});return{pass:!exception,invalid:invalid}}};var xhr=function(){var UNSENT=0,OPENED=1,HEADERS_RECEIVED=2,LOADING=3,DONE=4,ready=new RegExp(HEADERS_RECEIVED+"|"+LOADING),XMLHttpRequest,headers,handler,handlerError,
state;headers={"User-Agent":"abaaso/4.0.0 node.js/"+process.versions.node.replace(/^v/,"")+" ("+string.capitalize(process.platform)+" V8/"+process.versions.v8+" )","Content-Type":"text/plain","Accept":"*/*"};state=function(arg){if(this.readyState!==arg){this.readyState=arg;this.dispatchEvent("readystatechange");if(this.readyState===DONE&&!this._error){this.dispatchEvent("load");this.dispatchEvent("loadend")}}return this};handler=function(res){var self=this;state.call(this,HEADERS_RECEIVED);this.status=
res.statusCode;this._resheaders=res.headers;if(this._resheaders["set-cookie"]!==undefined&&this._resheaders["set-cookie"]instanceof Array)this._resheaders["set-cookie"]=this._resheaders["set-cookie"].join(";");res.on("data",function(arg){res.setEncoding("utf8");if(self._send){if(arg)self.responseText+=arg;state.call(self,LOADING)}});res.on("end",function(){if(self._send){state.call(self,DONE);self._send=false}})};handlerError=function(e){this.status=503;this.statusText=e;this.responseText=e!==undefined?
e.stack||e:e;this._error=true;this._send=false;this.setRequestHeader("Content-Type","text/plain");this.dispatchEvent("error");state.call(this,DONE)};XMLHttpRequest=function(){this.onabort=null;this.onerror=null;this.onload=null;this.onloadend=null;this.onloadstart=null;this.onreadystatechange=null;this.readyState=UNSENT;this.response=null;this.responseText="";this.responseType="";this.responseXML=null;this.status=UNSENT;this.statusText="";this._id=utility.genId();this._error=false;this._headers={};
this._listeners={};this._params={};this._request=null;this._resheaders={};this._send=false};XMLHttpRequest.prototype.abort=function(){if(this._request!==null){this._request.abort();this._request=null}this.responseText="";this.responseXML="";this._error=true;this._headers={};if(this._send===true||ready.test(this.readyState)){this._send=false;state.call(this,DONE)}this.dispatchEvent("abort");this.readyState=UNSENT;return this};XMLHttpRequest.prototype.addEventListener=function(event,fn){if(!this._listeners.hasOwnProperty(event))this._listeners[event]=
[];this._listeners[event].add(fn);return this};XMLHttpRequest.prototype.dispatchEvent=function(event){var self=this;if(typeof this["on"+event]==="function")this["on"+event]();if(this._listeners.hasOwnProperty(event))array.each(this._listeners[event],function(i){if(typeof i==="function")i.call(self)});return this};XMLHttpRequest.prototype.getAllResponseHeaders=function(){var result="";if(this.readyState<HEADERS_RECEIVED)throw new Error(label.error.invalidStateNoHeaders);utility.iterate(this._resheaders,
function(v,k){result+=k+": "+v+"\n"});return result};XMLHttpRequest.prototype.getResponseHeader=function(header){var result;if(this.readyState<HEADERS_RECEIVED||this._error)throw new Error(label.error.invalidStateNoHeaders);result=this._resheaders[header]||this._resheaders[header.toLowerCase()];return result};XMLHttpRequest.prototype.open=function(method,url,async,user,password){var self=this;if(async!==undefined&&async!==true)throw new Error(label.error.invalidStateNoSync);this.abort();this._error=
false;this._params={method:method,url:url,async:async||true,user:user||null,password:password||null};utility.iterate(headers,function(v,k){self._headers[k]=v});this.readyState=OPENED;return this};XMLHttpRequest.prototype.overrideMimeType=function(mime){this._headers["Content-Type"]=mime;return this};XMLHttpRequest.prototype.removeEventListener=function(event,fn){if(!this._listeners.hasOwnProperty(event))return;this._listeners[event].remove(fn);return this};XMLHttpRequest.prototype.send=function(data){data=
data||null;var self=this,options,parsed,request,obj;if(this.readyState<OPENED)throw new Error(label.error.invalidStateNotOpen);else if(this._send)throw new Error(label.error.invalidStateNotSending);parsed=utility.parse(this._params.url);parsed.port=parsed.port||(parsed.protocol==="https:"?443:80);if(this._params.user!==null&&this._params.password!==null)parsed.auth=this._params.user+":"+this._params.password;if(regex.put_post.test(this._params.method))this._headers["Content-Length"]=data!==null?Buffer.byteLength(data):
0;this._headers.Host=parsed.hostname+(!regex.http_ports.test(parsed.port)?":"+parsed.port:"");options={hostname:parsed.hostname,path:parsed.path,port:parsed.port,method:this._params.method,headers:this._headers};if(parsed.protocol==="https:"){options.rejectUnauthorized=false;options.agent=false}if(parsed.auth!==undefined)options.auth=parsed.auth;self._send=true;self.dispatchEvent("readystatechange");obj=parsed.protocol==="http:"?http:https;request=obj.request(options,function(arg){handler.call(self,
arg)}).on("error",function(e){handlerError.call(self,e)});data===null?request.setSocketKeepAlive(true,1E4):request.write(data,"utf8");this._request=request;request.end();self.dispatchEvent("loadstart");return this};XMLHttpRequest.prototype.setRequestHeader=function(header,value){if(this.readyState!==OPENED)throw new Error(label.error.invalidStateNotUsable);else if(this._send)throw new Error(label.error.invalidStateNotSending);this._headers[header]=value;return this};return XMLHttpRequest};var xml=
{decode:function(arg){if(typeof arg!=="string"||string.isEmpty(arg))throw new Error(label.error.invalidArguments);return(new DOMParser).parseFromString(arg,"text/xml")},encode:function(arg,wrap){try{if(arg===undefined)throw new Error(label.error.invalidArguments);wrap=wrap!==false;var x=wrap?"<xml>":"",top=arguments[2]!==false,node;node=function(name,value){var output="<n>v</n>";output=output.replace("v",regex.cdata.test(value)?"<![CDATA["+value+"]]\x3e":value);return output.replace(/<(\/)?n>/g,"<$1"+
name+">")};if(arg!==null&&arg.xml!==undefined)arg=arg.xml;if(arg instanceof Document)arg=(new XMLSerializer).serializeToString(arg);if(regex.boolean_number_string.test(typeof arg))x+=node("item",arg);else if(typeof arg==="object")utility.iterate(arg,function(v,k){x+=xml.encode(v,typeof v==="object",false).replace(/item|xml/g,isNaN(k)?k:"item")});x+=wrap?"</xml>":"";if(top)x='<?xml version="1.0" encoding="UTF8"?>'+x;return x}catch(e){utility.error(e,arguments,this);return undefined}},valid:function(arg){return xml.decode(arg).getElementsByTagName("parsererror").length===
0}};function Abaaso(arg){var self=this;if(arg)array.each(utility.$(arg),function(i){self.push(i)})}Abaaso.prototype=[];Abaaso.prototype.constructor=Abaaso;Abaaso.prototype.addClass=function(arg){return array.each(this,function(i){element.klass(i,arg)})};Abaaso.prototype.after=function(type,args){var result=new Abaaso;array.each(this,function(i){result.push(element.create(type,args,i,"after"))});return result};Abaaso.prototype.append=function(type,args){var result=new Abaaso;array.each(this,function(i){result.push(element.create(type,
args,i,"last"))});return result};Abaaso.prototype.appendTo=function(obj){var target=obj[0]||obj;return array.each(this,function(i){target.appendChild(i)})};Abaaso.prototype.at=function(n){var result=new Abaaso;result.push(this[n]);return result};Abaaso.prototype.attr=function(key,value){return array.each(this,function(i){element.attr(i,key,value)})};Abaaso.prototype.before=function(type,args){var result=new Abaaso;array.each(this,function(i){result.push(element.create(type,args,i,"before"))});return result};
Abaaso.prototype.clear=function(){return array.each(this,function(i){element.clear(i)})};Abaaso.prototype.create=function(type,args,position){var result=new Abaaso;array.each(this,function(i){result.push(element.create(type,args,i,position))});return result};Abaaso.prototype.css=function(key,value){return array.each(this,function(i){element.css(i,key,value)})};Abaaso.prototype.data=function(key,value){if(value!==undefined)return array.each(this,function(i){element.data(i,key,value)});else return this.map(function(i){return element.data(i,
key)})};Abaaso.prototype.datalist=function(store,template,options){return array.each(this,function(i){datalist(i,store,template,options)})};Abaaso.prototype.disable=function(){return array.each(this,function(i){element.disable(i)})};Abaaso.prototype.dispatch=function(event,data,bubbles,cancelable){return array.each(this,function(i){element.dispatch(i,event,data,bubbles,cancelable)})};Abaaso.prototype.destroy=function(){array.each(this,function(i){element.destroy(i)});return new Abaaso};Abaaso.prototype.each=
function(arg,async,size){var self=this;return array.each(this,function(i,idx){var instance=new Abaaso;instance.push(i);arg.call(self,instance,idx)},async,size)};Abaaso.prototype.enable=function(){return array.each(this,function(i){element.enable(i)})};Abaaso.prototype.find=function(arg){var result=new Abaaso;array.each(this,function(i){array.each(element.find(i,arg),function(r){result.push(r)})});return result};Abaaso.prototype.fire=function(){var args=arguments;return array.each(this,function(i){observer.fire.apply(observer,
[i].concat(array.cast(args)))})};Abaaso.prototype.filter=function(datalist,filters,debounce){return array.each(this,function(i){filter(i,datalist,filters,debounce)})};Abaaso.prototype.forEach=function(arg,async,size){return this.each(arg,async,size)};Abaaso.prototype.genId=function(){return array.each(this,function(i){utility.genId(i)})};Abaaso.prototype.get=function(uri,headers){return array.each(this,function(i){client.request("GET",uri,headers,function(arg){element.html(i,arg)},function(e){element.html(i,
e)})})};Abaaso.prototype.grid=function(store,fields,sortable,options,filtered,debounce){return array.each(this,function(i){grid(i,store,fields,sortable,options,filtered,debounce)})};Abaaso.prototype.has=function(arg){var result=new Abaaso;array.each(this.filter(function(i){return element.has(i,arg)}),function(i){result.push(i)});return result};Abaaso.prototype.hasClass=function(arg){var result=new Abaaso;array.each(this.filter(function(i){return element.hasClass(i,arg)}),function(i){result.push(i)});
return result};Abaaso.prototype.html=function(arg){var result;if(arg!==undefined){array.each(this,function(i){element.html(i,arg)});return this}else{result=[];array.each(this,function(i){result.push(element.html(i))});return result}};Abaaso.prototype.is=function(arg){var result=new Abaaso;array.each(this.filter(function(i){return element.is(i,arg)}),function(i){result.push(i)});return result};Abaaso.prototype.isAlphaNum=function(){var result=new Abaaso;array.each(this.filter(function(i){return element.isAlphaNum(i)}),
function(i){result.push(i)});return result};Abaaso.prototype.isBoolean=function(){var result=new Abaaso;array.each(this.filter(function(i){return element.isBoolean(i)}),function(i){result.push(i)});return result};Abaaso.prototype.isChecked=function(){var result=new Abaaso;array.each(this.filter(function(i){return element.isChecked(i)}),function(i){result.push(i)});return result};Abaaso.prototype.isDate=function(){var result=new Abaaso;array.each(this.filter(function(i){return element.isDate(i)}),
function(i){result.push(i)});return result};Abaaso.prototype.isDisabled=function(){var result=new Abaaso;array.each(this.filter(function(i){return element.isDisabled(i)}),function(i){result.push(i)});return result};Abaaso.prototype.isDomain=function(){var result=new Abaaso;array.each(this.filter(function(i){return element.isDomain(i)}),function(i){result.push(i)});return result};Abaaso.prototype.isEmail=function(){var result=new Abaaso;array.each(this.filter(function(i){return element.isEmail(i)}),
function(i){result.push(i)});return result};Abaaso.prototype.isEmpty=function(){var result=new Abaaso;array.each(this.filter(function(i){return element.isEmpty(i)}),function(i){result.push(i)});return result};Abaaso.prototype.isHidden=function(){var result=new Abaaso;array.each(this.filter(function(i){return element.isHidden(i)}),function(i){result.push(i)});return result};Abaaso.prototype.isIP=function(){var result=new Abaaso;array.each(this.filter(function(i){return element.isIP(i)}),function(i){result.push(i)});
return result};Abaaso.prototype.isInt=function(){var result=new Abaaso;array.each(this.filter(function(i){return element.isInt(i)}),function(i){result.push(i)});return result};Abaaso.prototype.isNumber=function(){var result=new Abaaso;array.each(this.filter(function(i){return element.isNumber(i)}),function(i){result.push(i)});return result};Abaaso.prototype.isPhone=function(){var result=new Abaaso;array.each(this.filter(function(i){return element.isPhone(i)}),function(i){result.push(i)});return result};
Abaaso.prototype.isUrl=function(){var result=new Abaaso;array.each(this.filter(function(i){return element.isUrl(i)}),function(i){result.push(i)});return result};Abaaso.prototype.last=function(arg){var result=new Abaaso,tmp=array.last(this,arg);if(isNaN(arg)||arg<2)tmp=tmp!==undefined?[tmp]:[];array.each(tmp,function(i){result.push(i)});return result};Abaaso.prototype.limit=function(start,offset){var result=new Abaaso;array.each(array.limit(this,start,offset),function(i){result.push(i)});return result};
Abaaso.prototype.listeners=function(event){var result=[];array.each(this,function(i){result.push(abaaso.listeners(i,event))});return result};Abaaso.prototype.loading=function(){return array.each(this,function(i){utility.loading(i)})};Abaaso.prototype.on=function(event,listener,id,scope,state){return array.each(this,function(i){observer.add(i,event,listener,id,scope||i,state)})};Abaaso.prototype.once=function(event,listener,id,scope,state){return array.each(this,function(i){observer.once(i,event,listener,
id,scope||i,state)})};Abaaso.prototype.position=function(){var result=[];array.each(this,function(i){result.push(element.position(i))});return result};Abaaso.prototype.prepend=function(type,args){var result=new Abaaso;array.each(this,function(i){result.push(element.create(type,args,i,"first"))});return result};Abaaso.prototype.remove=function(start,end){return array.remove(this,start,end)};Abaaso.prototype.removeIf=function(fn){return array.removeIf(this,fn)};Abaaso.prototype.removeWhile=function(fn){return array.removeWhile(this,
fn)};Abaaso.prototype.removeAttr=function(key){return array.each(this,function(i){element.removeAttr(i,key)})};Abaaso.prototype.removeClass=function(arg){return array.each(this,function(i){element.klass(i,arg,false)})};Abaaso.prototype.serialize=function(string,encode){return this.map(function(i){element.serialize(i,string,encode)})};Abaaso.prototype.size=function(){return this.map(function(i){return element.size(i)})};Abaaso.prototype.text=function(arg){var result;if(arg!==undefined)return array.each(this,
function(i){var tmp;tmp={};tmp[i.innerText?"innerText":"text"]=arg;element.update(i,tmp)});else{result=[];array.each(this,function(i){result.push(string.trim(i[i.innerText?"innerText":"text"]))});return result}};Abaaso.prototype.tpl=function(arg){return array.each(this,function(i){utility.tpl(arg,i)})};Abaaso.prototype.toggleClass=function(arg){return array.each(this,function(i){element.toggleClass(i,arg)})};Abaaso.prototype.un=function(event,id,state){return array.each(this,function(i){observer.remove(i,
event,id,state)})};Abaaso.prototype.update=function(arg){return array.each(this,function(i){element.update(i,arg)})};Abaaso.prototype.val=function(arg){if(arg===undefined)return this.map(function(i){return element.val(i)});else return array.each(this,function(i){return element.val(i,arg)})};Abaaso.prototype.validate=function(){return this.map(function(i){return element.validate(i)})};function abaaso(arg){return new Abaaso(arg)}abaaso.prototype.constructor=abaaso;abaaso.array=array;abaaso.callback=
{};abaaso.client={activex:client.activex,android:client.android,blackberry:client.blackberry,chrome:client.chrome,firefox:client.firefox,ie:client.ie,ios:client.ios,linux:client.linux,mobile:client.mobile,opera:client.opera,osx:client.osx,playbook:client.playbook,safari:client.safari,tablet:client.tablet,version:0,webos:client.webos,windows:client.windows,del:function(uri,success,failure,headers,timeout){return client.request(uri,"DELETE",success,failure,null,headers,timeout)},get:function(uri,success,
failure,headers,timeout){return client.request(uri,"GET",success,failure,null,headers,timeout)},headers:function(uri,success,failure,timeout){return client.request(uri,"HEAD",success,failure,null,null,timeout)},patch:function(uri,success,failure,args,headers,timeout){return client.request(uri,"PATCH",success,failure,args,headers,timeout)},post:function(uri,success,failure,args,headers,timeout){return client.request(uri,"POST",success,failure,args,headers,timeout)},put:function(uri,success,failure,
args,headers,timeout){return client.request(uri,"PUT",success,failure,args,headers,timeout)},jsonp:function(uri,success,failure,callback){return client.jsonp(uri,success,failure,callback)},options:function(uri,success,failure,timeout){return client.request(uri,"OPTIONS",success,failure,null,null,timeout)},permissions:client.permissions,scrollPos:client.scrollPos,size:client.size};abaaso.cookie=cookie;abaaso.element=element;abaaso.json=json;abaaso.label=label;abaaso.loading={create:utility.loading,
url:null};abaaso.math=math;abaaso.message=message;abaaso.mouse=mouse;abaaso.number=number;abaaso.regex=regex;abaaso.state={};abaaso.string=string;abaaso.xml=xml;abaaso.alias=utility.alias;abaaso.allows=client.allows;abaaso.append=function(type,args,obj){if(obj instanceof Element)utility.genId(obj);return element.create(type,args,obj,"last")};abaaso.bootstrap=bootstrap;abaaso.channel=channel;abaaso.clear=element.clear;abaaso.clearTimer=utility.clearTimers;abaaso.clone=utility.clone;abaaso.coerce=utility.coerce;
abaaso.compile=utility.compile;abaaso.create=element.create;abaaso.css=utility.css;abaaso.data=datastore.decorator;abaaso.datalist=datalist.factory;abaaso.datastores={};abaaso.discard=function(arg){return observer.discard(arg)};abaaso.debounce=utility.debounce;abaaso.decode=json.decode;abaaso.defer=deferred;abaaso.define=utility.define;abaaso.del=function(uri,success,failure,headers,timeout){return client.request(uri,"DELETE",success,failure,null,headers,timeout)};abaaso.delay=utility.defer;abaaso.destroy=
element.destroy;abaaso.each=array.each;abaaso.encode=json.encode;abaaso.error=utility.error;abaaso.expire=cache.clean;abaaso.expires=12E4;abaaso.extend=utility.extend;abaaso.fib=utility.fib;abaaso.filter=filter;abaaso.fire=function(obj,event){var all=typeof obj==="object",o=all?obj:this,e=all?event:obj,args=[o,e].concat(array.remove(array.cast(arguments),0,!all?0:1));return observer.fire.apply(observer,args)};abaaso.forEach=array.each;abaaso.frag=element.frag;abaaso.fn=Abaaso.prototype;abaaso.genId=
utility.genId;abaaso.get=function(uri,success,failure,headers,timeout){return client.request(uri,"GET",success,failure,null,headers,timeout)};abaaso.grid=grid,abaaso.guid=function(){return utility.uuid().toUpperCase()};abaaso.hash=utility.hash,abaaso.headers=function(uri,success,failure,timeout){return client.request(uri,"HEAD",success,failure,null,{},timeout)};abaaso.hex=utility.hex;abaaso.hidden=element.hidden;abaaso.hook=observer.decorate;abaaso.id="abaaso";abaaso.iterate=utility.iterate;abaaso.jsonp=
function(uri,success,failure,callback){return client.jsonp(uri,success,failure,callback)};abaaso.listeners=function(obj,event){return observer.list(typeof obj==="object"?obj:this,event)};abaaso.listenersTotal=observer.sum;abaaso.log=utility.log;abaaso.logging=observer.log;abaaso.lru=lru;abaaso.merge=utility.merge;abaaso.object=utility.object;abaaso.observerable=observer.decorate;abaaso.on=function(obj,event,listener,id,scope,state){var all=typeof obj==="object",o,e,l,i,s,st;if(all){o=obj;e=event;
l=listener;i=id;s=scope;st=state}else{o=this;e=obj;l=event;i=listener;s=id;st=scope}if(s===undefined)s=o;return observer.add(o,e,l,i,s,st)};abaaso.once=function(obj,event,listener,id,scope,state){var all=typeof obj==="object",o,e,l,i,s,st;if(all){o=obj;e=event;l=listener;i=id;s=scope;st=state}else{o=this;e=obj;l=event;i=listener;s=id;st=scope}if(s===undefined)s=o;return observer.once(o,e,l,i,s,st)};abaaso.options=function(uri,success,failure,timeout){return client.request(uri,"OPTIONS",success,failure,
null,null,timeout)};abaaso.parse=utility.parse;abaaso.patch=function(uri,success,failure,args,headers,timeout){return client.request(uri,"PATCH",success,failure,args,headers,timeout)};abaaso.pause=function(arg){return observer.pause(arg!==false)};abaaso.permissions=client.permissions;abaaso.position=element.position;abaaso.post=function(uri,success,failure,args,headers,timeout){return client.request(uri,"POST",success,failure,args,headers,timeout)};abaaso.prepend=function(type,args,obj){if(obj instanceof
Element)obj.genId();return element.create(type,args,obj,"first")};abaaso.prevent=utility.prevent;abaaso.promise=promise.factory;abaaso.property=utility.property;abaaso.put=function(uri,success,failure,args,headers,timeout){return client.request(uri,"PUT",success,failure,args,headers,timeout)};abaaso.queryString=function(key,string){return utility.queryString(key,string)};abaaso.random=number.random;abaaso.ready=false;abaaso.reflect=utility.reflect;abaaso.repeat=utility.repeat;abaaso.repeating=function(){return array.keys(utility.repeating)};
abaaso.script=client.script;abaaso.scroll=client.scroll;abaaso.scrollTo=element.scrollTo;abaaso.stylesheet=client.stylesheet;abaaso.stop=utility.stop;abaaso.store=datastore.decorator;abaaso.sugar=utility.sugar;abaaso.target=utility.target;abaaso.tpl=utility.tpl;abaaso.un=function(obj,event,id,state){var all=typeof obj==="object",o,e,i,s;if(all){o=obj;e=event;i=id;s=state}else{o=this;e=obj;i=event;s=id}return observer.remove(o,e,i,s)};abaaso.update=element.update;abaaso.uuid=utility.uuid;abaaso.validate=
validate.test;abaaso.version="4.0.0";abaaso.walk=utility.walk;abaaso.when=utility.when;bootstrap=function(){var cleanup,fn,init;cleanup=function(obj){observer.remove(obj);array.each(array.cast(obj.childNodes),function(i){cleanup(i)})};fn=function(){if(regex.complete_loaded.test(document.readyState)){init();return false}};init=function(){utility.repeat(function(){cache.clean()},6E4,"cacheGarbageCollector");observer.fire("abaaso","init, ready");observer.remove("abaaso","init, ready")};utility.error.log=
[];if(!server){abaaso.client.version=client.version=client.version();abaaso.client.mobile=client.mobile=client.mobile.call(this);abaaso.client.tablet=client.tablet=client.tablet.call(this);if(client.ie&&client.version<10)throw new Error(label.error.upgrade);}else XMLHttpRequest=xhr();has=Object.prototype.hasOwnProperty;slice=Array.prototype.slice;if(!server){observer.add(global,"error",function(e){observer.fire("abaaso","error",e)},"error",global,"all");observer.add(global,"hashchange",function(){observer.fire("abaaso",
"beforeHash, hash, afterHash",location.hash)},"hash",global,"all");observer.add(global,"load",function(){observer.fire("abaaso","render");observer.remove("abaaso","render");observer.remove(this,"load")});if(typeof Object.observe==="function")observer.add(global,"DOMNodeInserted",function(e){var obj=utility.target(e);Object.observe(obj,function(arg){observer.fire(obj,"change",arg)})},"mutation",global,"all");observer.add(global,"DOMNodeRemoved",function(e){var obj=utility.target(e);if(obj.id!==undefined&&
(!string.isEmpty(obj.id)&&e.relatedNode instanceof Element))cleanup(obj)},"mutation",global,"all")}utility.property(abaaso.state,"current",{enumerable:true,get:state.getCurrent,set:state.setCurrent});utility.property(abaaso.state,"previous",{enumerable:true,get:state.getPrevious,set:state.setPrevious});utility.property(abaaso.state,"header",{enumerable:true,get:state.getHeader,set:state.setHeader});abaaso.ready=true;if(typeof exports!=="undefined"||(typeof define=="function"||regex.complete_loaded.test(document.readyState)))init();
else if(typeof document.addEventListener==="function")document.addEventListener("DOMContentLoaded",function(){init()},false);else if(typeof document.attachEvent==="function")document.attachEvent("onreadystatechange",fn);else utility.repeat(fn)};bootstrap();WORKER="var "+string.fromObject(array,"array")+", "+string.fromObject(regex,"regex")+", "+string.fromObject(string,"string")+", "+string.fromObject(utility,"utility")+"; onmessage = "+datastore.worker.toString()+";";return abaaso}();if(typeof exports!==
"undefined")module.exports=framework;else if(typeof define==="function")define(function(){return framework});else global.abaaso=framework})(this);
//@ sourceMappingURL=abaaso.map
