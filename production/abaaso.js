/**
 * Copyright (c) 2010 - 2012, Jason Mulligan <jason.mulligan@avoidwork.com>
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above copyright
 *       notice, this list of conditions and the following disclaimer in the
 *       documentation and/or other materials provided with the distribution.
 *     * Neither the name of abaaso nor the
 *       names of its contributors may be used to endorse or promote products
 *       derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL JASON MULLIGAN BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/**
 * abaaso
 *
 * Events: init           Fires when abaaso is ready; register modules on this event
 *         ready          Fires when the DOM is available
 *         render         Fires when the window resources have loaded
 *         resize         Fires when the window resizes; parameter for listeners is abaaso.client.size
 *         afterCreate    Fires after an Element is created; parameter for listeners is the (new) Element
 *         afterDestroy   Fires after an Element is destroyed; parameter for listeners is the (removed) Element.id value
 *         beforeCreate   Fires when an Element is about to be created; parameter for listeners is the (new) Element.id value
 *         beforeDestroy  Fires when an Element is about to be destroyed; parameter for listeners is the (to be removed) Element
 *         error          Fires when an Error is caught; parameter for listeners is the logged Object (abaaso.error.log[n])
 *         beforeHash     Fires before the hash event
 *         hash           Fires when window.location.hash changes; parameter for listeners is the hash value
 *         afterHash      Fires after the hash event; parameter for listeners is the hash value
 *
 * @author Jason Mulligan <jason.mulligan@avoidwork.com>
 * @link http://abaaso.com/
 * @module abaaso
 * @version 2.5.4
 */
(function(e){"use strict";var t=e.document,n=e.location,r=e.navigator;typeof e.$=="undefined"&&(e.$=null),typeof e.abaaso=="undefined"&&(e.abaaso=function(){var i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E;return s={add:function(e,t){return s.contains(e,t)||e.push(t),e},cast:function(e,t){t=t===!0;var n=[],r,i;switch(!0){case!isNaN(e.length):!u.ie||u.version>8?n=Array.prototype.slice.call(e):y.iterate(e,function(e,t){t!=="length"&&n.push(e)});break;default:t?n=s.keys(e):y.iterate(e,function(e){n.push(e)})}return n},clone:function(e){return y.clone(e)},contains:function(e,t){return s.index(e,t)>-1},diff:function(e,t){var n=e.length>t.length?e:t,r=n===e?t:e;return n.filter(function(e){return!s.contains(r,e)})},each:function(e,t){var n=0;return e.forEach(function(r){t.call(e,r,n++)}),e},first:function(e){return e[0]},index:function(e,t){return e.indexOf(t)},indexed:function(e){var t=[];return y.iterate(e,function(e,n){typeof e=="object"?t=t.concat(s.indexed(e)):t.push(e)}),t},intersect:function(e,t){var n=e.length>t.length?e:t,r=n===e?t:e;return n.filter(function(e){return s.contains(r,e)})},keys:function(e){var t=[];return typeof Object.keys=="function"?t=Object.keys(e):y.iterate(e,function(e,n){t.push(n)}),t},last:function(e){return e[e.length-1]},range:function(e,t,n){var r=[],i;for(i=t;i<=n;i++)r.push(e[i]);return r},remove:function(e,t,n){if(typeof t=="string"){t=e.index(t);if(t===-1)return e}else t=t||0;var r=e.length,i=e.slice((n||t)+1||r);return e.length=t<0?r+t:t,e.push.apply(e,i),e},sort:function(e,t){var n=!1,r;!isNaN(e)&&!isNaN(t)&&(n=!0),e=n?v.parse(e):String(e),t=n?v.parse(t):String(t);switch(!0){case e<t:r=-1;break;case e>t:r=1;break;default:r=0}return r},total:function(e){return s.indexed(e).length},toObject:function(e){var t={},n=e.length;while(n--)t[n.toString()]=e[n];return t}},o={items:{},clean:function(){return y.iterate(o.items,function(e,t){o.expired(t)&&o.expire(t)})},expire:function(e,t){return t=t===!0,typeof o.items[e]!="undefined"?(delete o.items[e],t||e.fire("beforeExpire, expire, afterExpire"),!0):!1},expired:function(e){var t=o.items[e];return typeof t!="undefined"&&typeof t.expires!="undefined"&&t.expires<new Date},get:function(e,t){return t=t!==!1,typeof o.items[e]=="undefined"?!1:t&&o.expired(e)?(o.expire(e),!1):y.clone(o.items[e])},set:function(e,t,n){return typeof o.items[e]=="undefined"&&(o.items[e]={},o.items[e].permission=0),t==="permission"?o.items[e].permission|=n:t==="!permission"?o.items[e].permission&=~n:o.items[e][t]=n,o.items[e]}},u={android:function(){return/android/i.test(r.userAgent)}(),blackberry:function(){return/blackberry/i.test(r.userAgent)}(),chrome:function(){return/chrome/i.test(r.userAgent)}(),firefox:function(){return/firefox/i.test(r.userAgent)}(),ie:function(){return/msie/i.test(r.userAgent)}(),ios:function(){return/ipad|iphone/i.test(r.userAgent)}(),linux:function(){return/linux|bsd|unix/i.test(r.userAgent)}(),mobile:function(){abaaso.client.mobile=this.mobile=/blackberry|iphone|webos/i.test(r.userAgent)||/android/i.test(r.userAgent)&&(abaaso.client.size.height<720||abaaso.client.size.width<720)},playbook:function(){return/playbook/i.test(r.userAgent)}(),opera:function(){return/opera/i.test(r.userAgent)}(),osx:function(){return/macintosh/i.test(r.userAgent)}(),safari:function(){return/safari/i.test(r.userAgent.replace(/chrome.*/i,""))}(),tablet:function(){abaaso.client.tablet=this.tablet=/ipad|playbook|webos/i.test(r.userAgent)||/android/i.test(r.userAgent)&&(abaaso.client.size.width>=720||abaaso.client.size.width>=720)},webos:function(){return/webos/i.test(r.userAgent)}(),windows:function(){return/windows/i.test(r.userAgent)}(),version:function(){var e=0;switch(!0){case this.chrome:e=r.userAgent.replace(/(.*chrome\/|safari.*)/gi,"");break;case this.firefox:e=r.userAgent.replace(/(.*firefox\/)/gi,"");break;case this.ie:e=r.userAgent.replace(/(.*msie|;.*)/gi,"");break;case this.opera:e=r.userAgent.replace(/(.*opera\/|\(.*)/gi,"");break;case this.safari:e=r.userAgent.replace(/(.*version\/|safari.*)/gi,"");break;default:e=typeof r!="undefined"?r.appVersion:0}return e=isNaN(parseInt(e))?0:parseInt(e),abaaso.client.version=this.version=e,e},allows:function(e,t){if(e.isEmpty()||t.isEmpty())throw Error(h.error.invalidArguments);if(!o.get(e,!1))return undefined;t=t.toLowerCase();var n;switch(!0){case t==="delete":n=(u.permissions(e,t).bit&1)!==0;break;case t==="get":n=(u.permissions(e,t).bit&4)!==0;break;case/post|put/.test(t):n=(u.permissions(e,t).bit&2)!==0;break;default:n=!1}return n},bit:function(e){var t=0;return e.each(function(e){switch(e.toLowerCase()){case"get":t|=4;break;case"post":case"put":t|=2;break;case"delete":t|=1}}),t},cors:function(e){return e.indexOf("//")>-1&&e.indexOf("//"+n.host)===-1},headers:function(e,t,n){var r=String(e.getAllResponseHeaders()).split("\n"),s={},a={},f=null,l=new Date,c,h;r.each(function(e){e.isEmpty()||(c=e.toString(),h=c.substr(c.indexOf(":")+1,c.length).replace(/\s/,""),c=c.substr(0,c.indexOf(":")).replace(/\s/,""),c=function(){var e=[];return c.explode("-").each(function(t){e.push(t.capitalize())}),e.join("-")}(),s[c]=h,/allow|access-control-allow-methods/i.test(c)&&(f=h))});switch(!0){case typeof s["Cache-Control"]!="undefined"&&/no/.test(s["Cache-Control"]):case typeof s.Pragma!="undefined"&&/no/.test(s.Pragma):break;case typeof s["Cache-Control"]!="undefined"&&/\d/.test(s["Cache-Control"]):l=l.setSeconds(l.getSeconds()+parseInt(/\d{1,}/.exec(s["Cache-Control"])[0]));break;case typeof s.Expires!="undefined":l=new Date(s.Expires);break;default:l=l.setSeconds(l.getSeconds()+i.expires)}return a.expires=l,a.headers=s,a.permission=u.bit(f!==null?f.explode():[n]),n!=="head"&&(o.set(t,"expires",a.expires),o.set(t,"headers",a.headers),o.set(t,"permission",a.permission)),a},parse:function(e,t){t=t||"";var n,r;switch(!0){case(/json|plain|javascript/.test(t)||t.isEmpty())&&Boolean(r=c.decode(/[\{\[].*[\}\]]/.exec(e.responseText),!0)):n=r;break;case/xml/.test(t)&&String(e.responseText).isEmpty()&&e.responseXML!==null:n=w.decode(typeof e.responseXML.xml!="undefined"?e.responseXML.xml:e.responseXML);break;case/<[^>]+>[^<]*]+>/.test(e.responseText):n=w.decode(e.responseText);break;default:n=e.responseText}return n},permissions:function(e){var t=o.get(e,!1),n=t?t.permission:0,r={allows:[],bit:n,map:{read:4,write:2,"delete":1}};return n&1&&r.allows.push("DELETE"),n&2&&function(){r.allows.push("POST"),r.allows.push("PUT")}(),n&4&&r.allows.push("GET"),r},jsonp:function(e,t,n,r){var s=e,o=y.guid(!0),u,a,f;switch(!0){case typeof r=="undefined":case r===null:case r instanceof Object&&(r.callback===null||typeof r.callback=="undefined"):case typeof r=="string"&&r.isEmpty():u="callback";break;case r instanceof Object&&typeof r.callback!="undefined":u=r.callback;break;default:u="callback"}s=s.replace(u+"=?",""),s.once("afterJSONP",function(e){this.un("failedJSONP",o),typeof t=="function"&&t(e)},o).once("failedJSONP",function(){this.un("failedJSONP",o),typeof n=="function"&&n()},o);do a=y.genId().slice(0,10);while(typeof abaaso.callback[a]!="undefined");return e=e.replace(u+"=?",u+"=abaaso.callback."+a),abaaso.callback[a]=function(e){f.destroy(),clearTimeout(abaaso.timer[a]),delete abaaso.timer[a],delete abaaso.callback[a],s.fire("afterJSONP",e)},f=i("head").create("script",{src:e,type:"text/javascript"}),abaaso.timer[a]=setTimeout(function(){s.fire("failedJSONP")},3e4),e},request:function(e,t,n,r,i,s){if(/post|put/i.test(t)&&typeof i=="undefined")throw Error(h.error.invalidArguments);t=t.toLowerCase(),s=s instanceof Object?s:null;var a=u.cors(e),f=u.ie&&u.version<10&&a?new XDomainRequest:new XMLHttpRequest,l=/post|put/i.test(t)&&typeof i!="undefined"?i:null,p=t==="get"?o.get(e):!1,d=t.capitalize(),v=y.guid(!0),m=null,g=typeof Document!="undefined",b=typeof ArrayBuffer!="undefined",S=typeof Blob!="undefined";t==="delete"&&e.once("afterDelete",function(){o.expire(this)}),e.once("after"+d,function(t){e.un("failed"+d,v),typeof n=="function"&&n(t)},v).once("failed"+d,function(t){e.un("after"+d,v),typeof r=="function"&&r(t)},v).fire("before"+d);if(t!=="head"&&e.allows(t)===!1)return e.fire("failed"+d);if(t==="get"&&Boolean(p))e.fire("afterGet",p.response);else{f[f instanceof XMLHttpRequest?"onreadystatechange":"onload"]=function(){u.response(f,e,t)},typeof f.ontimeout=="object"&&(f.ontimeout=function(t){e.fire("timeout"+d,t)}),typeof f.onprogress=="object"&&(f.onprogress=function(t){e.fire("progress"+d,t)}),typeof f.upload.onprogress=="object"&&(f.upload.onprogress=function(t){e.fire("progressUpload"+d,t)});try{f.open(t.toUpperCase(),e,!0),s!==null&&s.hasOwnProperty("Content-Type")&&(m=s["Content-Type"]),a&&m===null&&(m="text/plain"),l!==null&&(l.hasOwnProperty("xml")&&(l=l.xml),g&&l instanceof Document&&(l=w.decode(l)),typeof l=="string"&&/<[^>]+>[^<]*]+>/.test(l)&&(m="application/xml"),!(b&&l instanceof ArrayBuffer)&&!(S&&l instanceof Blob)&&l instanceof Object&&(m="application/json",l=c.encode(l)),m===null&&(b&&l instanceof ArrayBuffer||S&&l instanceof Blob)&&(m="application/octet-stream"),m===null&&(m="application/x-www-form-urlencoded; charset=UTF-8")),typeof f.setRequestHeader=="function"&&(typeof p=="object"&&p.headers.hasOwnProperty("ETag")&&f.setRequestHeader("ETag",p.headers.ETag),s===null&&(s={}),m!==null&&(s["Content-Type"]=m),s.hasOwnProperty("callback")&&delete s.callback,y.iterate(s,function(e,t){e!==null&&t!=="withCredentials"&&f.setRequestHeader(t,e)})),typeof f.withCredentials=="boolean"&&s!==null&&typeof s.withCredentials=="boolean"&&(f.withCredentials=s.withCredentials),e.fire("beforeXHR",{xhr:f,uri:e}),l!==null?f.send(l):f.send()}catch(x){E(x,arguments,this,!0),e.fire("failed"+d,{response:u.parse(f),xhr:f})}}return e},response:function(e,t,r){var i=r.toLowerCase().capitalize(),s=n,a=null,f,l,p,d,v;switch(!0){case e.readyState===2:t.fire("received"+i);break;case e.readyState===4:t.fire("afterXHR",{xhr:e,uri:t});try{switch(e.status){case 200:case 201:case 202:case 203:case 204:case 205:case 206:case 301:f=abaaso.state,l=u.headers(e,t,r),p=u.cors(t);switch(!0){case r==="head":return t.fire("afterHead",l.headers);case r!=="delete"&&/200|201/.test(e.status):v=typeof l.headers["Content-Type"]!="undefined"?l.headers["Content-Type"]:"",d=u.parse(e,v);if(typeof d=="undefined")throw Error(h.error.serverError);o.set(t,"response",l.response=y.clone(d))}f.header!==null&&Boolean(a=l.headers[f.header])&&f.current!==a&&(typeof f.change=="function"?f.change(a):f.current=a);switch(e.status){case 200:case 201:t.fire("after"+i,d);break;case 202:case 203:case 204:case 206:t.fire("after"+i);break;case 205:t.fire("reset");break;case 301:t.fire("moved",d)}break;case 401:throw Error(h.error.serverUnauthorized);case 403:throw o.set(t,"!permission",u.bit([r])),Error(h.error.serverForbidden);case 405:throw o.set(t,"!permission",u.bit([r])),Error(h.error.serverInvalidMethod);case 0:default:throw Error(h.error.serverError)}}catch(m){E(m,arguments,this,!0),t.fire("failed"+i,{response:u.parse(e),xhr:e})}break;case u.ie&&u.cors(t):var d,g;switch(!0){case Boolean(g=c.decode(/[\{\[].*[\}\]]/.exec(e.responseText))):d=g;break;case/<[^>]+>[^<]*]+>/.test(e.responseText):d=w.decode(e.responseText);break;default:d=e.responseText}o.set(t,"permission",u.bit(["get"])),o.set(t,